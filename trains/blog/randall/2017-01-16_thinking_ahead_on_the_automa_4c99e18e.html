<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Randall Museum Model Railroad" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/randall/2017-01-16_thinking_ahead_on_the_automa_4c99e18e.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Thinking ahead on the Automation Software" />

<meta property="og:description" content="Here's a rethink of the automation software." />


<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="Thinking ahead on the Automation Software" />

<meta name="twitter:description" content="Here's a rethink of the automation software." />


<title>Blog: Randall Museum Model Railroad</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0018.html">Blog: Randall Museum Model Railroad</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<table style="border-collapse:collapse;border-spacing:0;margin-left:auto;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:119.5pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/index.html" style="color:inherit;text-decoration:inherit">Introduction</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:119.5pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Blog &amp; News</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:119.5pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/about.html" style="color:inherit;text-decoration:inherit">About the Model Railroad</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:119.5pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac.html" style="color:inherit;text-decoration:inherit">RTAC Software</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:119.5pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/videos.html" style="color:inherit;text-decoration:inherit">Videos</a></span></p></td>
  </tr>
 </tbody>
</table>
<p></p>
<p><span style="font-style:italic">The Randall Museum in San Francisco hosts a large HO-scale model railroad. Created by the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="http://www.ggmrc.org" style="color:inherit;text-decoration:inherit">Golden Gate Model Railroad Club</a></span><span style="font-style:italic">&nbsp;starting in 1961, the layout was donated to the Museum in 2015. Since then I have started automatizing trains running on the layout. I am also the model railroad maintainer. </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">This blog</a></span><span style="font-style:italic">&nbsp;describes various updates on the Randall Museum Model Railroad and I maintain a separate </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/train/" style="color:inherit;text-decoration:inherit">tech blog for all my electronics &amp; software</a></span><span style="font-style:italic">&nbsp;not directly related to Randall. </span><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2017-02-19_progress_on_train_automation_b18326d0.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2017-01-16_lights_and_sound.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2017-01-16 - Thinking ahead on the Automation Software</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">Randall</span>
    </span>
    </div>


    <p><span>Here's a rethink of the automation software.</span></p>
<p></p>
<p><span>Right now I have JMRI for sensor management and DCC throttles. Conductor acts as a plug-in that drives the automation purley on sensor+timer event based script.</span></p>
<p></p>
<p><span>One useful thing in RocRail is the notion of routes, which JMRI has too of course (but annoyingly complex to setup).</span></p>
<p></p>
<p><span>The idea is to describe the model railroad using a chain of blocks with turnouts on or between them.</span></p>
<p><span><br>The timer/sensor script remains the same, but the goal is to have the software know which engine number is on which block. This in turn will drive the display and make it possible to lock routes.</span></p>
<p></p>
<p><span>Example, for the Passenger and Branchline automation:</span></p>
<p></p>
<p><span>BL1 ⇒ BL2 [T324] ⇒ void ⇒ BL3 ⇒ BL4</span></p>
<p><span>B503b ⇒ B503a ⇒ [T504] ⇒ [T321] B321 [T322] [T326] ⇒ [T330] B330 ⇒ void ⇒ B360 ⇒ B370</span></p>
<p><span>[T322] ⇒ B322 [T324] ⇒ [T326]</span></p>
<p><span>B310 ⇒ [T320] B320 ⇒ [T330]</span></p>
<p><span>B311 [T311] ⇒ [T321]</span></p>
<p></p>
<p><span>One difficulty is to express the relation of turnouts and blocks. There are also some void unknown blocks where the software has no visibility but can easily assume that the train is located there.</span></p>
<p><span>That's one thing that determinist software like JMRI or RocRail do not handle.</span></p>
<p><span>E.g. in the case of the passenger automation, right now the blocks B321 and B330 up to B350 are not detected, but once the automation has started we know that the train must be there somewhere till it reaches B360, at which point the train info can be transferred to B360.</span></p>
<p></p>
<p><span>Note that a train can be on two blocks at the same time if they are continuous. That's the case when crossing from one block to the next one, especially if there are lighted cars or push-pull engines.</span></p>
<p></p>
<p><span>What is this information good for?</span></p>
<p></p>
<p><span>First for display. One goal is to have a summary track representation on the tablet with the blocks and the train number should show up on that where the software think it is. That means if something is wrong, the viewer can notice it and act on it.</span></p>
<p></p>
<p><span>Second for emergency. When doing the Passenger automation, we expect the train leaving B503a to reach B330 in a specific amount of time, namely 50 seconds till we reduce the speed past the Sonora turnout. We can add some margin to it, e.g. say 60 seconds max. If we have no detected B330 turning on within 60 second, we can assume something is wrong.</span></p>
<p></p>
<p><span>Third for turnout protection. It would be ideal if the automation could prevent from aligning turnouts if their block or the next one is occupied. This would be only for automated routes. Manual operators could always realign turnouts.</span></p>
<p></p>
<p><span>Finally for automating train speed under automatic block control. E.g. if the passenger automation is returning to the station, the following would happen:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>T330 (Sonora) needs to be aligned. However this can only be done if all of B330, B320 and B321 are not occupied.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>If B330 is occupied or if T330 cannot be aligned, the train needs to stop </span><span style="font-style:italic">before</span><span>&nbsp;the occupied block. Luckily for us, blocks are long enough that if we stop a train just when it enters a block, it will stay in that block and not stop in the next one. Otherwise we would have to program it to stop 2 blocks before. Also in this example, "before B330" going down is that "void" block but that's OK since we know that a train that passes B360 going enters that void block.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Finally, when whatever is occupying block B330, B320 &nbsp;and B321 leaves and the 3 blocks are free, the automation can throw the T330 turnout and resume the train.</span></li>
</ul>
<p></p>
<p><span>Knowing in which block the train is, it would not block itself from throwing a turnout. E.g. if the train is itself in B330, that should not prevent it from throwing T330.</span></p>
<p></p>
<p><span>One issue we have is that we have no real feedback on turnout position. We can only query JMRI to tell us what the turnout is likely to be at, unless an operator as manually changed it. JMRI has no knowledge of that. The NCE PH Pro command station does but I don't believe JMRI is querying that [Update: it can. Define turnouts in Monitoring mode].</span></p>
<p></p>
<p><span>Once we have all this, we could rewrite the automation in a completely different way. For example for the passenger automation, the events could be purely block based and their order forming a route, e.g. something like this:</span></p>
<p></p>
<p><span>State Station:</span></p>
<p style="margin-left:36pt"><span>B503b &amp; Stopped &amp; Start ⇒ Align T504, T322, T321; State Up; Speed Fwd Normal; Expect B321 in 10s.</span></p>
<p><span>State Up:</span></p>
<p style="margin-left:36pt"><span>B321 ⇒ Align T322, T326, T330; After 40s do F3; Expect B330 in 50s.</span></p>
<p style="margin-left:36pt"><span>B330 ⇒ Speed Fwd Restricted; Expect void1</span></p>
<p style="margin-left:36pt"><span>Void1 ⇒ Align T370; Expect B360; After 10s do Speed Fwd Normal; After 15s do Horn</span></p>
<p style="margin-left:36pt"><span>B360 ⇒ Expect B370 in 10s</span></p>
<p style="margin-left:36pt"><span>B370 ⇒ After 8s do Speed Fwd Restricted; After 11s do Stop; After 15s do State Down.</span></p>
<p><span>State Down:</span></p>
<p style="margin-left:36pt"><span>B370 ⇒ Speed Rev Restricted; Expect B360</span></p>
<p><span>Etc.</span></p>
<p></p>
<p><span>So this describes the movement from block A to block B. Technically we don't even need to indicate which turnouts to throw, the software can compute that using the map described earlier.</span></p>
<p><span>One tricky part is that "void1" block since switching to that state relies on the block B330 going off instead of another sensor going on. Also calling it a "virtual block" instead of "void" may be better.</span></p>
<p></p>
<p><span>As far as the block graph is concerned, a train is thus located on a specific block (even if virtual) and with a specific direction within the block graph.</span></p>
<p></p>
<p><span>An end-goal of that is to allow "free" automated running. E.g. another train waiting at station track 2 could leave after the PA train once the blocks are free, or one could circle on the mainline and wait for the PA one when needed. For this we need to extend the concept of occupied block to occupied region -- e.g. B330 up to B370 is one region and can only have a single train at a time.</span></p>
<p></p>
<p></p>
<hr>
<p></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2017-02-19_progress_on_train_automation_b18326d0.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2017-01-16_lights_and_sound.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-04 by Rig4j 0.1-Exp-05cc7b2&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

