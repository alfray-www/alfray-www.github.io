<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/0003.html" />
<meta property="og:type"        content="article" />

<meta property="og:title"       content="Blog: Model Train-related Notes" />
<meta property="og:description" content="As noted above, during the first test running “live” with JMRI, all routes instantly became in error as soon as the engine moved and activated the next block for BL or PA." />
<meta property="og:image"       content="https://www.alfray.com/trains/blog/train/img_a829f4e69484dc20cd40f3a6598bf44058b39b80c08877b3ca33902362f14562i.jpg" />

<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->

<meta name="twitter:title"       content="Blog: Model Train-related Notes" />
<meta name="twitter:description" content="As noted above, during the first test running “live” with JMRI, all routes instantly became in error as soon as the engine moved and activated the next block for BL or PA." />
<meta name="twitter:image"       content="https://www.alfray.com/trains/blog/train/img_a829f4e69484dc20cd40f3a6598bf44058b39b80c08877b3ca33902362f14562i.jpg" />

<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0003.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">

    <span class="prev-page"><a href="0002.html">⇐ Newer Posts</a><br/></span>
    <span class="next-page"><a href="0004.html">Older Posts ⇒</a><br/></span>


</div>



    <div class="post-container">
<div class="post-title-container">
<a class="post-title-link" href="2023-04-03_conductor_2_changing_blocks.html">
    <h2 class="post-title">2023-04-03 - Conductor 2: Changing Blocks</h2>
</a>
<span class="post-cat" title="Category">
    <span class="post-cat-label">Category</span>
    <span class="post-cat-text">
    Rtac
    
    </span>
</span></div>

<p><span></span></p>
<p></p>
<p><span>As noted above, during the first test running “live” with JMRI, all routes instantly became in error as soon as the engine moved and activated the next block for BL or PA. </span></p>
<p></p>
<p><span>This is due to the simulator being too naive: it instantly changed from one block to the next one, in perfect sync. This made it “perfect” when I was debugging the engine. But unfortunately, that’s not how reality works: when an engine crosses a block boundary, both blocks become temporarily active since the engine bridges both blocks. And depending on the speed of the engine, this can be anywhere from a second to a handful of seconds.</span></p>
<p><span>It’s actually even a bit worse than that as even non-powered car wheels can bridge two blocks for a fraction of a second.</span></p>
<p><span></span></p>

<a href="2023-04-03_conductor_2_changing_blocks.html">Click here to continue reading...</a>
<p/>
<hr/>
</div>
<div class="post-container">
<div class="post-title-container">
<a class="post-title-link" href="2023-04-02_conductor_2_live_test_deployment.html">
    <h2 class="post-title">2023-04-02 - Conductor 2: Live Test Deployment</h2>
</a>
<span class="post-cat" title="Category">
    <span class="post-cat-label">Category</span>
    <span class="post-cat-text">
    Rtac
    
    </span>
</span></div>

<p><span></span></p>
<p></p>
<p><span>I’m now proceeding with the first tests of the new </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac" style="color:inherit;text-decoration:inherit">Conductor 2</a></span><span>&nbsp;“live” at the museum using JMRI and the actual trains, and the first two tests have been… interesting. In the pure line of “</span><span style="font-style:italic">no plan survives first contact with the enemy</span><span>”, both tests were highly “educational” and produced a list of issues to address.</span></p>
<p></p>
<p><span>Since I’m doing quotes, let’s also quote Eisenhower’s “</span><span style="font-style:italic">plans are worthless, but planning is everything</span><span>”. The planning I did recently to </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/train/2023-03-12_conductor_2_test-only_deployment.html" style="color:inherit;text-decoration:inherit">prepare for the deployment</a></span><span>&nbsp;really paid off and I was able to </span><span style="font-style:italic">run</span><span>&nbsp;the tests easily -- that is I can trivially change accounts on the automation computer and switch between the stable current Conductor 1 setup and the experimental Conductor 2 setup. Then when the computer boots every morning, I’m guaranteed it will safely run the stable version automatically. That’s where that bit of planning paid off.</span></p>
<p></p>
<p><span>A bunch of unexpected things happened during the experimental Conductor 2 tests, and I collected enough data to know &nbsp;what to do next. I would have been highly suspicious if the new automation engine had worked perfectly out of the box. It didn’t, and more importantly I got some valuable data to work on it.</span></p>
<p><span></span></p>

<a href="2023-04-02_conductor_2_live_test_deployment.html">Click here to continue reading...</a>
<p/>
<hr/>
</div>
<div class="post-container">
<div class="post-title-container">
<a class="post-title-link" href="2023-03-31_conductor_2_dsl_activeroute.html">
    <h2 class="post-title">2023-03-31 - Conductor 2 DSL: ActiveRoute</h2>
</a>
<span class="post-cat" title="Category">
    <span class="post-cat-label">Category</span>
    <span class="post-cat-text">
    Rtac
    
    </span>
</span></div>

<p><span></span></p>
<p></p>
<p><span>One thing I still don’t like in the Conductor 2 DSL is the name of the “ActiveRoute” object.</span></p>
<p><span>It’s misleading and confusing.</span></p>
<p><span>As a reminder, in the current DSL:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>An “active route” is a list of routes, of which only one is active at a single time.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>A route is a sequence of nodes, each node corresponding to one block in a given direction.</span></li>
</ul>
<p></p>
<p><span>It’s fairly misleading as one may think that an “active route” is one route that has become active, when it is actually a container of routes combined with a switch selector.</span></p>
<p></p>
<p><span>Possible name alternatives:</span></p>
<p><span></span></p>

<a href="2023-03-31_conductor_2_dsl_activeroute.html">Click here to continue reading...</a>
<p/>
<hr/>
</div>
<div class="post-container">
<div class="post-title-container">
<a class="post-title-link" href="2023-03-25_buildings_led_lighting.html">
    <h2 class="post-title">2023-03-25 - Buildings’ LED Lighting</h2>
</a>
<span class="post-cat" title="Category">
    <span class="post-cat-label">Category</span>
    <span class="post-cat-text">
    
    <a class="post-cat-link" href="../../blog/train" title="View All Category Posts">Train</a>
    </span>
</span></div>

<p></p>
<p><span>Orion, Allen, and I had a discussion on how to refresh the buildings’ lighting on the layout.</span></p>
<p></p>
<p><span>For the record, the current lighting uses the traditional 12V light bulb system, controlled by a central massive power supply under the main yard, with rows of toggle switches mostly unused. Wiring is the usual mess (a.k.a. both neat yet over-complicated and hard to trace). We don’t know which buildings are equipped with lights, nor which light bulbs are either not working or not connected.</span></p>
<p><span>I’ve made an attempt identify the power supply and what few buildings are </span><span style="font-style:italic">visibly</span><span>&nbsp;lighted here:<br> </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/about.html#h.p043jf65vl34" style="color:inherit;text-decoration:inherit">https://www.alfray.com/trains/randall/about.html#h.p043jf65vl34</a></span></p>
<p></p>
<p><span>One thought is that next time we dust the city, we should inventory which buildings are equipped with wires, and map existing through-holes in the support boards.</span></p>
<p></p>
<p><span>But going forward, how should we improve the lighting?</span></p>
<p><span></span></p>

<a href="2023-03-25_buildings_led_lighting.html">Click here to continue reading...</a>
<p/>
<hr/>
</div>
<div class="post-container">
<div class="post-title-container">
<a class="post-title-link" href="2023-03-12_conductor_2_test-only_deployment.html">
    <h2 class="post-title">2023-03-12 - Conductor 2: Test-only Deployment</h2>
</a>
<span class="post-cat" title="Category">
    <span class="post-cat-label">Category</span>
    <span class="post-cat-text">
    Rtac
    
    </span>
</span></div>

<p><span></span></p>
<p></p>
<p><span>Let’s discuss </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac" style="color:inherit;text-decoration:inherit">Conductor 2</a></span><span>&nbsp;strategies for deployment.</span></p>
<p></p>
<p><span>One issue is that I can’t just install this on the main automation computer at the museum and just “hope it works the first time”. Even though it’s volunteer work, I take it seriously and I have an unofficial SLA of 7/5 -- my automation needs to work reliably for 7 hours for 5 days a week. That makes my downtime only two days (Sunday and Monday), one being a workday for me, so really I have one day to get stuff done, and it’s on the week-ends when I often have other commitments. Then I wonder why any project takes so long to accomplish… oh well.</span></p>
<p></p>
<p><span>So the solution is that I have a clone of the automation computer at Randall. It’s the “backup” computer in case the main one fails. It’s a 99.9% exact setup so it’s nice for testing software upgrades. And because I can’t often easily go on place, I also have </span><span style="font-style:italic">another</span><span>&nbsp;fairly similar machine at home for testing. Thus I deploy on the machine at home, sort of a canary, and if I like it, I deploy on the backup machine at the museum, and finally on the main one. It’s a bit of a process but it works neatly. I can identify issues early, as is the case here.</span></p>
<p></p>
<p><span>My early attempt at deployment failed, and I addressed it already.</span></p>
<p><span></span></p>

<a href="2023-03-12_conductor_2_test-only_deployment.html">Click here to continue reading...</a>
<p/>
<hr/>
</div>
<div class="post-container">
<div class="post-title-container">
<a class="post-title-link" href="2023-03-04_sdb_wifi_and_configuration.html">
    <h2 class="post-title">2023-03-04 - SDB: Wifi and Configuration</h2>
</a>
<span class="post-cat" title="Category">
    <span class="post-cat-label">Category</span>
    <span class="post-cat-text">
    SDB
    
    </span>
</span></div>

<p><span></span></p>
<p></p>
<p><span style="font-style:italic">The </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/model-railroad/sdb" style="color:inherit;text-decoration:inherit">Software Defined Blocks</a></span><span style="font-style:italic">&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad</span><span>.</span></p>
<p></p>
<p><span>Wifi offers the typical bootstrap dilemma on all these tiny gizmos: we need to select an SSID and enter some wifi credentials to connect to an existing network.</span></p>
<p></p>
<p><span>The typical “Arduino way” to deal with this problem is to encode both the SSID and the password in the Arduino code. That forces users to recompile the Arduino sketch before deploying.</span></p>
<p><span>On devices with an sdcard, a work-around is to have users create a small config file with the info that we can read at boot.</span></p>
<p><span>Here instead I want to have the traditional “wifi-enabled gizmo” behavior.</span></p>
<p></p>
<p><span>An ESP32 running SDB shall offer this behavior:</span></p>
<p style="text-align:left"><span></span></p>

<a href="2023-03-04_sdb_wifi_and_configuration.html">Click here to continue reading...</a>
<p/>
<hr/>
</div>
<div class="post-container">
<div class="post-title-container">
<a class="post-title-link" href="2023-02-28_sdb_using_freertos_tasks_priorities.html">
    <h2 class="post-title">2023-02-28 - SDB: Using FreeRTOS Tasks & Priorities</h2>
</a>
<span class="post-cat" title="Category">
    <span class="post-cat-label">Category</span>
    <span class="post-cat-text">
    SDB
    
    </span>
</span></div>

<p><span></span></p>
<p></p>
<p><span style="font-style:italic">The </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/model-railroad/sdb" style="color:inherit;text-decoration:inherit">Software Defined Blocks</a></span><span style="font-style:italic">&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad</span><span>.</span></p>
<p></p>
<p><span>How can the current modules benefit from the FreeRTOS tasks?</span></p>
<p></p>
<p><span>An initial prototype was built using MicroPython. There’s good support for ESP32, especially using the Adafruit libraries. Unfortunately, MicroPython on ESP32 still has quite some limitations. For example there’s no OpenCV support, etc. Since the goal is to make the project as accessible as possible, sticking to the regular Arduino / C++ seemed a better option.</span></p>
<p></p>
<p><span>One issue with the MicroPython version is that I realized that “MicroPython Threads” are implemented using FreeRTOS tasks all of the same priority. Thus they execute in round robin fashion, with no control from the application. That means a task doing some IO can be pre-empted in the middle of e.g. an I2C-in-software operation.</span></p>
<p></p>
<p><span>With better FreeRTOS control, we can use tasks and we can:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Use priorities to ensure some tasks are run before others.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Use critical sections or mutexes to avoid same-priority tasks from interrupting each other.</span></li>
</ul>
<p style="text-align:left"><span></span></p>

<a href="2023-02-28_sdb_using_freertos_tasks_priorities.html">Click here to continue reading...</a>
<p/>
<hr/>
</div>
<div class="post-container">
<div class="post-title-container">
<a class="post-title-link" href="2023-02-25_split_core_hall-effect_sensors.html">
    <h2 class="post-title">2023-02-25 - Split Core & Hall-Effect Sensors</h2>
</a>
<span class="post-cat" title="Category">
    <span class="post-cat-label">Category</span>
    <span class="post-cat-text">
    Electronics
    
    </span>
</span></div>

<p><span></span></p>
<p><span>For now I’ve been doing block detection on the Randall layout using NCE BD20 current detectors. They work well. There are others DCC-compatible detectors but they all use through-hole core transformers, which means they cannot be used with existing wiring without desoldering or disconnecting something.</span></p>
<p></p>
<p style="text-align:center"><span style="-webkit-transform:rotate(0.00rad) translateZ(0px);border:0.00px solid #000000;display:inline-block;height:265.33px;margin:0.00px 0.00px;overflow:hidden;transform:rotate(0.00rad) translateZ(0px);width:796.80px"><img alt="" src="img_a829f4e69484dc20cd40f3a6598bf44058b39b80c08877b3ca33902362f14562i.jpg" style="height:597.75px;margin-left:-0.00px;margin-top:-292.37px" title=""></span></p>
<p></p>
<p><span>There are other contenders to the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://ncedcc.zendesk.com/hc/en-us/articles/201254549-BD20-Block-Detector" style="color:inherit;text-decoration:inherit">BD20</a></span><span>, such as the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.modelrailroadcontrolsystems.com/cpod-control-point-occupancy-detector/" style="color:inherit;text-decoration:inherit">cpOD</a></span><span>&nbsp;and the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.iascaled.com/store/CKT-BD1" style="color:inherit;text-decoration:inherit">CKT-BD1</a></span><span>. I plan to switch to these once I exhaust my current supply of BD20. But the bottom line is that they all use these “through-hole CT”, and sometimes I wished I had the convenience of a split core transformer that I could quickly snap around a track feeder wire.</span></p>
<p></p>
<p><span>I had two goals in mind:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Main goal: Have an alternative to the through-hole CT block detection sensors that do not require disconnecting nor cutting wires to install them.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Secondary goal: Make a little portable “current detector” that I could quickly snap around a track feed wire to trace wire continuity.</span></li>
</ul>
<p></p>
<p><span>Thus a while ago I got two sensors, with the purpose of figuring out to use them to monitor train track current with an ESP32:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://amzn.to/3q7qG4z" style="color:inherit;text-decoration:inherit">https://amzn.to/3q7qG4z</a></span><span>&nbsp;</span><span>Hall-sensing ACS712-5A current module.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://amzn.to/3AJM5FP" style="color:inherit;text-decoration:inherit">https://amzn.to/3AJM5FP</a></span><span>&nbsp;</span><span>Split core SCT013-005 5A 1V current transformer.</span></li>
</ul>
<p></p>
<p><span>Spoiler alert: I discussed that topic on the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://forum.mrhmag.com/post/equivalent-of-bd20-block-detector-with-split-core-transformers-12438761" style="color:inherit;text-decoration:inherit">MRH forum</a></span><span>&nbsp;and the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://groups.io/g/arduini/topic/93449311" style="color:inherit;text-decoration:inherit">Arduini forum</a></span><span>&nbsp;and I was clearly told that would not work, and to make a long story short, I never managed to make them work for this application.</span></p>
<p></p>
<p><span>Upfront I want to indicate why that was anyway not a surprise and I was likely to fail:</span></p>
<p><span></span></p>

<a href="2023-02-25_split_core_hall-effect_sensors.html">Click here to continue reading...</a>
<p/>
<hr/>
</div>
<div class="post-container">
<div class="post-title-container">
<a class="post-title-link" href="2023-02-24_sdb_mqtt.html">
    <h2 class="post-title">2023-02-24 - SDB: MQTT</h2>
</a>
<span class="post-cat" title="Category">
    <span class="post-cat-label">Category</span>
    <span class="post-cat-text">
    SDB
    
    </span>
</span></div>

<p><span></span></p>
<p></p>
<p><span style="font-style:italic">The </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/model-railroad/sdb" style="color:inherit;text-decoration:inherit">Software Defined Blocks</a></span><span style="font-style:italic">&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad</span><span>.</span></p>
<p></p>
<p><span>The base idea is to use </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://learn.adafruit.com/alltheiot-protocols/mqtt" style="color:inherit;text-decoration:inherit">MQTT</a></span><span>&nbsp;to publish block changes, instead of targeting the JMRI JSON protocol. I was originally going to support both, but that seems redundant. We’ll see. JSON is simple and very convenient for debugging, so it’s always a great idea to get started.</span></p>
<p></p>
<p><span>Here we’ll detail how that works for this specific project:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>ESP32 monitors sensors, sends messages to an MQTT broker.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>JMRI MQTT subscribes to messages from the MQTT broker.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Requirement: An MQTT broker running on the network (either the same machine as JMRI, or another local one, or a public one).</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Requirement: Set up the ESP32 with the broker IP, and block/sensor topics.</span></li>
</ul>
<p></p>
<p><span>For background, my </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac.html" style="color:inherit;text-decoration:inherit">RTAC Conductor automation software</a></span><span>&nbsp;embeds “KV Server”, a distributed key-value server/client architecture which is fundamentally very similar to MQTT, except mine is nowhere as ubiquitous and it is </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/ralfoide/libutils/tree/android-lib-v2" style="color:inherit;text-decoration:inherit">buried somewhere in my LibUtils project</a></span><span>. In the case of the Conductor automation software, I use the KV Server as a way to distribute configuration from the automation script to the accessories. Which means we can do the same here with MQTT, and we can take advantage of that to configure the ESP32 with block triggers defined in the automation script.</span></p>
<p><span></span></p>

<a href="2023-02-24_sdb_mqtt.html">Click here to continue reading...</a>
<p/>
<hr/>
</div>
<div class="post-container">
<div class="post-title-container">
<a class="post-title-link" href="2023-02-22_alternatives_locations_for_b_d7713a5c.html">
    <h2 class="post-title">2023-02-22 - Alternatives Locations for Block Detection at Randall</h2>
</a>
<span class="post-cat" title="Category">
    <span class="post-cat-label">Category</span>
    <span class="post-cat-text">
    
    <a class="post-cat-link" href="../../blog/train" title="View All Category Posts">Train</a>
    </span>
</span></div>

<p></p>
<p><span>For now I’ve been doing block detection on the Randall layout using NCE BD20 current detectors. I have part of the Mountain Panel wired, and I’d like to have more there. I’d like to also have block detection of part of the Valley, and that’s where I have been hitting a wall for the last two years. I just can’t figure out a clean way to do it.</span></p>
<p></p>
<p><span>Block detection using BD20-style current detectors can be done at various points. Let’s review the possibilities:</span></p>
<p><span></span></p>

<a href="2023-02-22_alternatives_locations_for_b_d7713a5c.html">Click here to continue reading...</a>
<p/>
<hr/>
</div>





<div class="prev-next-container">

    <span class="prev-page"><a href="0002.html">⇐ Newer Posts</a><br/></span>
    <span class="next-page"><a href="0004.html">Older Posts ⇒</a><br/></span>


</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-02 by Rig4j 0.1-Exp-05cc7b2&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

