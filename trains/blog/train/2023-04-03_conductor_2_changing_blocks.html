<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/2023-04-03_conductor_2_changing_blocks.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Conductor 2: Changing Blocks" />

<meta property="og:description" content="As noted above, during the first test running “live” with JMRI, all routes instantly became in error as soon as the engine moved and activated the next block for BL or PA." />


<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="Conductor 2: Changing Blocks" />

<meta name="twitter:description" content="As noted above, during the first test running “live” with JMRI, all routes instantly became in error as soon as the engine moved and activated the next block for BL or PA." />


<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0003.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2023-04-05_conductor_2_maps.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-04-02_conductor_2_live_test_deployment.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2023-04-03 - Conductor 2: Changing Blocks</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">Rtac</span>
    </span>
    </div>


    <p><span></span></p>
<p></p>
<p><span>As noted above, during the first test running “live” with JMRI, all routes instantly became in error as soon as the engine moved and activated the next block for BL or PA. </span></p>
<p></p>
<p><span>This is due to the simulator being too naive: it instantly changed from one block to the next one, in perfect sync. This made it “perfect” when I was debugging the engine. But unfortunately, that’s not how reality works: when an engine crosses a block boundary, both blocks become temporarily active since the engine bridges both blocks. And depending on the speed of the engine, this can be anywhere from a second to a handful of seconds.</span></p>
<p><span>It’s actually even a bit worse than that as even non-powered car wheels can bridge two blocks for a fraction of a second.</span></p>
<p><span></span></p>
<p></p>
<p><span>That’s not exactly news and in the design of Conductor 2 I had clearly specified we should account for two blocks to be active.</span></p>
<p><span>However, the sequence route manager implementation is also too idealistic: I was trying to compensate for this, but I only compensate for the next block to be active. The problem is that as soon as an engine starts crossing a block boundary, that next block does become active (which is handled), and thus becomes the new “current” block. That means now that the old trailing block is active, and that’s not supported. Duh. I didn’t see that one coming:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Train direction → </span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>“occupied” represents where the engine thinks the train is located.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>“active” represents the actual track sensor’ state. They should ideally match.</span></li>
 </ul>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Step 1: </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ block 1 -- empty ] [</span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 2 -- occupied active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [ block 3 -- empty ] [ block 4 -- empty ]</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Train moves from block 2 to block 3, we temporarily have blocks 2+3 active:</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Step 2: </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ block 1 -- empty ] [</span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 2 -- occupied active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [</span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 3 -- active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [ block 4 -- empty ]</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Block 3 becoming active is expected. The engine knows the train is moving to block 3:</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Step 3: </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ block 1 -- empty ] [</span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 2 -- active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [</span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 3 -- occupied active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [ block 4 -- empty ]</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Error! We did not expect the </span><span style="font-style:italic">previous</span><span>&nbsp;block to be active too!</span></li>
</ul>
<p></p>
<p><span>Here’s an easy solution: when we move an engine along the blocks’ sequence, we mark the old block as “trailing”. There can be only one “trailing” block in a sequence -- it’s the one we come from. That’s also part of the Conductor 2 design, so we're going to use this property here.</span></p>
<p><span>If we wanted to be cautious, we could filter and only take trailing blocks whose nodes have an outgoing link to the current one -- this way we know these are blocks “we come from”. In practice, this is supposed to be guaranteed by the fact we have only one active block, and it’s the last one that was active before we changed blocks.</span></p>
<p></p>
<p><span>That means that in order to fix the issue, we just need to allow:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The “next block in the sequence” to be active.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The “trailing block” (aka the last one we came from) to be active.</span></li>
</ul>
<p></p>
<p><span>Now our state machine looks like this:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Train direction → </span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>“occupied” represents where the engine thinks the train is located.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>“trailing” represents where the engine knows the train </span><span style="font-style:italic">was</span><span>&nbsp;before.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>“active” represents the actual track sensor’ state. They should ideally match.</span></li>
 </ul>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Step 1: </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ block 1 -- empty ] [</span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 2 -- occupied active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [ block 3 -- empty ] [ block 4 -- empty ]</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Train moves from block 2 to block 3, we temporarily have blocks 2+3 active:</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Step 2: </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ block 1 -- empty ] [</span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 2 -- occupied active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [</span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 3 -- active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [ block 4 -- empty ]</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Block 3 becoming active is expected. The engine knows the train is moving to block 3:</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Step 3: </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ block 1 -- empty ] [</span><span style="background-color:rgb(252, 229, 205);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 2 -- trialing active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [</span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 3 -- occupied active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [ block 4 -- empty ]</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>This state is accepted: the trailing block can be temporarily active while the train fully moves to block 3:</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>Step 3: </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ block 1 -- empty ] [</span><span style="background-color:rgb(252, 229, 205);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 2 -- trialing </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [</span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;block 3 -- occupied active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">] [ block 4 -- empty ]</span></li>
</ul>
<p></p>
<p><span>This requires updating the map to display the trailing blocks, as that’s useful debug information for me to have.</span></p>
<p></p>
<p><span>Update: later I will discover I forgot about reversing blocks. A reversing block is interesting because the “previous” trailing block (where we come from) is </span><span style="font-style:italic">also</span><span>&nbsp;the next outgoing block.</span></p>
<p></p>
<hr>
<p></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2023-04-05_conductor_2_maps.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-04-02_conductor_2_live_test_deployment.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-01 by Rig4j 0.1-Exp-0c45755&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

