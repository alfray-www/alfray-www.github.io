<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/2023-02-28_sdb_using_freertos_tasks_priorities.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="SDB: Using FreeRTOS Tasks & Priorities" />

<meta property="og:description" content="The Software Defined Blocks&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad." />


<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="SDB: Using FreeRTOS Tasks & Priorities" />

<meta name="twitter:description" content="The Software Defined Blocks&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad." />


<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0003.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2023-03-04_sdb_wifi_and_configuration.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-02-25_split_core_hall-effect_sensors.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2023-02-28 - SDB: Using FreeRTOS Tasks & Priorities</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">SDB</span>
    </span>
    </div>


    <p><span></span></p>
<p></p>
<p><span style="font-style:italic">The </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/model-railroad/sdb" style="color:inherit;text-decoration:inherit">Software Defined Blocks</a></span><span style="font-style:italic">&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad</span><span>.</span></p>
<p></p>
<p><span>How can the current modules benefit from the FreeRTOS tasks?</span></p>
<p></p>
<p><span>An initial prototype was built using MicroPython. There’s good support for ESP32, especially using the Adafruit libraries. Unfortunately, MicroPython on ESP32 still has quite some limitations. For example there’s no OpenCV support, etc. Since the goal is to make the project as accessible as possible, sticking to the regular Arduino / C++ seemed a better option.</span></p>
<p></p>
<p><span>One issue with the MicroPython version is that I realized that “MicroPython Threads” are implemented using FreeRTOS tasks all of the same priority. Thus they execute in round robin fashion, with no control from the application. That means a task doing some IO can be pre-empted in the middle of e.g. an I2C-in-software operation.</span></p>
<p></p>
<p><span>With better FreeRTOS control, we can use tasks and we can:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Use priorities to ensure some tasks are run before others.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Use critical sections or mutexes to avoid same-priority tasks from interrupting each other.</span></li>
</ul>
<p style="text-align:left"><span></span></p>
<p style="text-align:left"></p>
<p><span>The design suggestion is as follows for Core and Task Priorities:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Core 0:</span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Priority ? = wifi tasks.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Priority 0 = idle task.</span></li>
 </ul>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Core 1:</span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Priority 4 = sensor acquisition.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Priority 3 = (optional) block logic &amp; IO notifications.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Priority 2 = (optional) display updates.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Priority 1 = main loop.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Priority 0 = idle task. </span></li>
 </ul>
</ul>
<p></p>
<p><span>We’ll still have modules with an init + loop, but these are called from the main loop.</span></p>
<p><span>Each module is free to start its own sensor acquisition tasks as desired, with the caveats:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>They all share a </span><span style="font-style:italic">common</span><span>&nbsp;mutex to prevent select operations from being preempted.</span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>We will provide that via the shared module manager.</span></li>
 </ul>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>They must yield reasonably using </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/freertos_idf.html?highlight=xtaskdelay#_CPPv410vTaskDelayK10TickType_t" style="color:inherit;text-decoration:inherit">vTaskDelay</a></span><span>&nbsp;or </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/freertos_idf.html?highlight=xtaskdelay#_CPPv415xTaskDelayUntilPC10TickType_tK10TickType_t" style="color:inherit;text-decoration:inherit">xTaskDelayUntil</a></span><span>&nbsp;-- because we do not require exact timings, the former one is good enough for our usage.</span></li>
</ul>
<p></p>
<p><span>Not every module needs to have a task. Because the main loop will still run, simple modules (display updates, block logic updates) can simply run in the loop callbacks.</span></p>
<p></p>
<p><span>We provide an “IO critical section mutex” via the module manager that can be used any time a specific IO operation must not be preempted. An example of such an operation would be an ADC measure, or reading from the ToF I2C, or updating the OLED buffer. Because sensors should use tasks all at the same priority on the same core, they will run in round robin.</span></p>
<p></p>
<p><span>We now have a situation where different tasks read and write from the data store. By construction, they cannot access it at the same time. The access </span><span style="font-style:italic">can</span><span>&nbsp;be preempted, as long as it’s by another task not performing data store operations.</span></p>
<p><span>For that, we’ll use a different mutex to protect reads and writes.</span></p>
<p><span>To ensure we cannot have deadlocks, both mutexes should not be held at the same time -- IO operations should not perform data store operations.</span></p>
<p></p>
<hr>
<p></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2023-03-04_sdb_wifi_and_configuration.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-02-25_split_core_hall-effect_sensors.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-01 by Rig4j 0.1-Exp-0c45755&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

