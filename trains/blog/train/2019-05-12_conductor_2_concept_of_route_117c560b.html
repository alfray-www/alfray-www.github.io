<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/2019-05-12_conductor_2_concept_of_route_117c560b.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Conductor 2: Concept of Routes & Virtual Blocks" />

<meta property="og:description" content="One of the main concepts to be added in Conductor 2&nbsp;is the concept of routes." />


<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="Conductor 2: Concept of Routes & Virtual Blocks" />

<meta name="twitter:description" content="One of the main concepts to be added in Conductor 2&nbsp;is the concept of routes." />


<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0006.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<table style="border-collapse:collapse;border-spacing:0;margin-left:auto;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/" style="color:inherit;text-decoration:inherit">Train Pages</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/train/" style="color:inherit;text-decoration:inherit">Tech Blog</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac.html" style="color:inherit;text-decoration:inherit">RTAC Software</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.youtube.com/c/raphaelmoll" style="color:inherit;text-decoration:inherit">Videos</a></span></p></td>
  </tr>
 </tbody>
</table>
<p></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2019-06-03_jupiter_steam_4-4-0_engine.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2019-04-14_conductor_2_includes_routes__b779f39a.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2019-05-12 - Conductor 2: Concept of Routes & Virtual Blocks</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">Rtac</span>
    </span>
    </div>


    <p><span></span></p>
<p></p>
<p><span>One of the main concepts to be added in </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac" style="color:inherit;text-decoration:inherit">Conductor 2</a></span><span>&nbsp;is the concept of routes.</span></p>
<p></p>
<p><span>Conductor 1 already has “route” definitions. These are actually intended for display on the remote tablets. A route is defined using:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>A name,</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>A DCC throttle object, used to display the engine speed and direction;</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The JMRI sensor used for the automation toggle on/off.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>A counter of number of times the automation started (incremented by the script).</span></li>
</ul>
<p></p>
<p><span>The counter thing was a quick attempt at gathering some stats initially and never used -- it’s technically displayed by RTAC on the tablet, but the UI layout was designed for 2 routes, and with the current 3 routes the counter is ironically not visible. Even when it was visible, nobody was looking at it. Thus I suggest dropping it eventually, which will remove a couple lines from the script.</span></p>
<p></p>
<p><span>The concept of routes in Conductor 2 is supposed to be more elaborate. However I’d posit it can just be an extension of what is in Conductor 1 </span><span style="font-style:italic">at the syntax level</span><span>&nbsp;in the script.</span></p>
<p></p>
<p><span>So what properties would I want in a Conductor 2 route?</span></p>
<p style="text-align:left"><span></span></p>
<p></p>
<p><span>Earlier I was trying to separate “engine profiles” from routes. However that can be explored later as the idea seem either moot, or flawed, or both.</span></p>
<p></p>
<p><span>What seems relevant however is to have the following route properties:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>1- The list of blocks &amp; turnouts that compose a route, for simulation and prediction.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>2- A route status as being active or idle.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>3- A simple route sequencing, e.g. to alternate between routes A and B.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>4- Automated route navigation modes influencing a localized window or global block locking scheme.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>5- Associating on..then events to a route rather than being global.</span></li>
</ul>
<p></p>
<p><span>The ordering matters in this list. Step 1 is something I can use right now. Step 2 and 3 are possible easy extensions. Steps 4 and 5 are more involved extensions, to be done much later.</span></p>
<p></p>
<p><span>To make it clear, routes can and are designed to overlap in their layout block/turnout usage. </span></p>
<p><span>In the current script, deciding which of the passenger or freight route runs next is done using a flip-flop enum. This could be equally done using a property on the route indicating which one is active or idle, and permuting that state between runs.</span></p>
<p></p>
<p><span>Let’s define what a route’s block and turnout list should look like.</span></p>
<p><span>In my case, all I need are extremely linear routes. There is no branching possible, that is a route is fixed and cannot change.</span></p>
<p></p>
<p><span>A generic description of a route is a graph with nodes and edges. Each node is an occupancy block (real or virtual) or a turnout, and each edge is a direction of travel between two nodes. Edges are directional.</span></p>
<p></p>
<p><span>For a more generic description, one could potentially imagine an automation case where a route is a non-cyclic graph with branches, and not just linear. That could be useful when associated with an exec engine that would select branches either randomly or other criteria. In the case of a limited number of choices, this is trivially simulated by choosing between multiple linear routes, which is exactly what I have here with the freight vs passenger routes.</span></p>
<p></p>
<p><span>One idea behind placing the turnouts in the route list is not for branching but for marking them as occupied/locked, and more important to define their default state. For example a fixed route list could indicate “B321, T330(N), B330”, thus indicating the required position of the turnout. This makes it possible to have a controller automatically setting the turnout to the requested position when the train reaches the block on either side.</span></p>
<p><span>As for marking a turnout as occupied, this allows it to be done automatically when a block on either side is occupied, so in the example above T330 would be marked as occupied as long as either B321 or B330 are occupied. This is mostly a display thing.</span></p>
<p></p>
<p><span>All my routes are currently operating in shuttle mode. This opens another choice, whether only half the route is defined, or whether the whole entire trip-and-back route is expressly defined. In other words, can blocks be repeated more than once. This also depends on whether there’s some kind of coordinator defining how the blocks are used along the route. Mapping only half means essentially that the route has a dynamic graph (or two graphs), depending on the direction of travel, or has directional edges which can dynamically change directions. Thus to keep it simple for now, a route will have the exact list of all blocks travelled, in the “forward” direction, which means double the numbers of blocks for a shuttle automation.</span></p>
<p></p>
<p><span>Thus a route definition will look something like this:</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">routeF = route {</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">&nbsp; &nbsp; name = "Freight" // defaults to variable name if omitted</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">&nbsp; &nbsp; toggle = PA_Toggle</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">&nbsp; &nbsp; throttle = SP</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">&nbsp; &nbsp; status = "PA_State"</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">&nbsp; &nbsp;route = [ B311, T311, T321, T320, B321, T330, B330, B340, B350v, B360, T370, T371, B370, T371, T370, B360, B350v, B340, T330, B330, B321, T320, T321, T311, B311 ]</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">&nbsp; &nbsp;active = false &nbsp;// implied</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">}</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">routeF.active = true</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">on { routeF.active } then { … }</span></p>
<p></p>
<p><span>The “route” property inside a route denotes the linear list of blocks and turnouts, which form the nodes of an implicit graph with forward-only edges.</span></p>
<p></p>
<p><span>The mention of the turnouts is for now to be omitted as they won’t be used for now. If present they could be marked as “locked” on a display map, or marked as occupied when any block next to them are occupied.</span></p>
<p></p>
<p><span style="font-weight:700">Virtual Blocks</span></p>
<p></p>
<p><span>In the example above, B350 is marked as “B350v” to denote it would be a virtual block. A virtual block is a sensor that has no physical backing (e.g. no JMRI sensor). These are blocks that are sandwiched between actual blocks, and on which the physical presence of a train is a given, thus I have not mapped a physical sensor to them. There are two ways to deal with them:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Automatically. Based on the direction of travel, a controller can trivially mark a virtual block as occupied when a train occupies the block before it, and release it when the next block is occupied. In the route example above, both “B340 B350v B360” and “B360 B350v B340” give us enough information to occupy and release the virtual block.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>By script. Being a sensor, the same can be done by programmatic rules. 4 rules are needed here per virtual block.</span></li>
</ul>
<p></p>
<p><span>For my current usage, I have two such blocks, one on the mainline and one on the branchline.</span></p>
<p></p>
<p><span>My current suggestion is to create them explicitly as such:</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">B340 &nbsp;= block “NS784”</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">B350v = virtualBlock [auto=true]</span></p>
<p></p>
<p><span>Both “block” and “virtualBlock” are aliases for the current “sensor” creation. They all return a CSensor object to the script. However blocks have extra </span><span style="font-style:italic">read-only</span><span>&nbsp;properties for Conductor, not related to a physical JMRI sensor:</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">block.occupied = true | false</span><span>&nbsp;(== sensor.active if backed by real sensor)</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">block.locked = true | false</span></p>
<p style="margin-left:36pt" class="console "><span style="font-family:&quot;Consolas&quot;">Block.position = float [0 … 1.0] or NaN</span></p>
<p></p>
<p><span>A new “block” keyword is actually introduced, and the syntax “sensor ‘NS785’” creates a non-block sensor, for example a toggle switch.</span></p>
<p></p>
<p><span style="font-weight:700">Block Position</span></p>
<p></p>
<p><span>The “position” property is for display only. It would be an </span><span style="font-style:italic">estimation</span><span>&nbsp;of the position of the train in the block, if known.</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>NaN is used when the block is not occupied </span><span style="font-style:italic">or</span><span>&nbsp;the position is not known. </span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>0..1 maps to the start-end of the block, with 0.5 being the middle. </span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>For each block I define a default “forward” direction -- in this layout, our default running direction is clockwise, and this is how the “forward” DCC direction is defined in the script.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>0 is defined as the location where a train would </span><span style="font-style:italic">enter</span><span>&nbsp;the block in forward direction, and 1 is defined as the location where a train would enter the block in reverse direction. 0..1 corresponds to the start-end comparatively to the forward direction.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The default location, when unknown for an occupied block, is in the middle at 0.5.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The location is reported as NaN for a non-occupied block.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>For example in a shuttle run, the position would first change from 0…0.5…1 when the train first goes up on a block, and then it would change from 1 … 0.5 … 0 when the train comes back.</span></li>
</ul>
<p></p>
<p><span>I’d also define an “occupancy controller” whose purpose is to govern these.</span></p>
<p></p>
<hr>
<p></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2019-06-03_jupiter_steam_4-4-0_engine.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2019-04-14_conductor_2_includes_routes__b779f39a.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-04 by Rig4j 0.1-Exp-05cc7b2&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

