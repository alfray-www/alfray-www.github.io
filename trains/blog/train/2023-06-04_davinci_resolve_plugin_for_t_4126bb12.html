<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/2023-06-04_davinci_resolve_plugin_for_t_4126bb12.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="DaVinci Resolve Plugin for the Mobius Car Ride Videos" />

<meta property="og:description" content="I have detailed in a previous post&nbsp;how I create my “car/cab ride” videos: a Mobius Maxi 4K&nbsp;is placed on a flat car, and either pulled or pushed by the train using a custom “3D-printed rod” draw-bar connector:" />
<meta property="og:image"       content="https://www.alfray.com/trains/blog/train/img_48910f9cda4521c63342fe228b08f754a23e18f6de0cab92722b68d4b7dca80fi.jpg" />

<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="DaVinci Resolve Plugin for the Mobius Car Ride Videos" />

<meta name="twitter:description" content="I have detailed in a previous post&nbsp;how I create my “car/cab ride” videos: a Mobius Maxi 4K&nbsp;is placed on a flat car, and either pulled or pushed by the train using a custom “3D-printed rod” draw-bar connector:" />
<meta name="twitter:image"       content="https://www.alfray.com/trains/blog/train/img_48910f9cda4521c63342fe228b08f754a23e18f6de0cab92722b68d4b7dca80fi.jpg" />

<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0002.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2023-07-01_conductor_2_w_google_analytics_4.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-05-21_conductor_2_now_the_default__3eef9fa3.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2023-06-04 - DaVinci Resolve Plugin for the Mobius Car Ride Videos</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">Video</span>
    </span>
    </div>


    <p><span></span></p>
<p></p>
<p><span>I have </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/train/2023-01-02_cab_ride_videos_with_the_mob_a8befb95.html" style="color:inherit;text-decoration:inherit">detailed in a previous post</a></span><span>&nbsp;how I create my “car/cab ride” videos: a </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/train/2023-01-01_mobius_maxi_4k.html" style="color:inherit;text-decoration:inherit">Mobius Maxi 4K</a></span><span>&nbsp;is placed on a flat car, and either pulled or pushed by the train using a custom “3D-printed rod” draw-bar connector:</span></p>
<p></p>
<p style="text-align:center"><span style="-webkit-transform:rotate(0.00rad) translateZ(0px);border:0.00px solid #000000;display:inline-block;height:186.67px;margin:0.00px 0.00px;overflow:hidden;transform:rotate(0.00rad) translateZ(0px);width:796.80px"><img alt="" src="img_48910f9cda4521c63342fe228b08f754a23e18f6de0cab92722b68d4b7dca80fi.jpg" style="margin-left:0.00px;margin-top:0.00px" title=""></span></p>
<p></p>
<p><span>The only issue with this approach is the extremely visible rod on the camera, even after cropping a 1080p out of the 4K video. I’ve had many comments that it’s quite distracting; I fully agree; it’s been bugging me too:</span></p>
<p></p>
<table style="border-collapse:collapse;border-spacing:0;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="border-bottom-color:rgb(0, 0, 0);border-bottom-style:solid;border-bottom-width:0pt;border-left-color:rgb(0, 0, 0);border-left-style:solid;border-left-width:0pt;border-right-color:rgb(0, 0, 0);border-right-style:solid;border-right-width:0pt;border-top-color:rgb(0, 0, 0);border-top-style:solid;border-top-width:0pt;vertical-align:top;width:298.8pt"><p style="text-align:left"><span style="vertical-align:baseline">Could there be a way to go from this:</span></p></td>
   <td colspan="1" rowspan="1" style="border-bottom-color:rgb(0, 0, 0);border-bottom-style:solid;border-bottom-width:0pt;border-left-color:rgb(0, 0, 0);border-left-style:solid;border-left-width:0pt;border-right-color:rgb(0, 0, 0);border-right-style:solid;border-right-width:0pt;border-top-color:rgb(0, 0, 0);border-top-style:solid;border-top-width:0pt;vertical-align:top;width:298.8pt"><p style="text-align:left"><span style="vertical-align:baseline">to that?</span></p></td>
  </tr>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="border-bottom-color:rgb(0, 0, 0);border-bottom-style:solid;border-bottom-width:0pt;border-left-color:rgb(0, 0, 0);border-left-style:solid;border-left-width:0pt;border-right-color:rgb(0, 0, 0);border-right-style:solid;border-right-width:0pt;border-top-color:rgb(0, 0, 0);border-top-style:solid;border-top-width:0pt;vertical-align:top;width:298.8pt"><p style="text-align:left"><span style="-webkit-transform:rotate(0.00rad) translateZ(0px);border:0.00px solid #000000;display:inline-block;height:227.00px;margin:0.00px 0.00px;overflow:hidden;transform:rotate(0.00rad) translateZ(0px);width:396.00px"><img alt="" src="img_94be166920357993a8a643026f82cffc702f7681fd969c2353a9c7f7e1a95385i.jpg" style="height:248.00px;margin-left:0.00px;margin-top:-21.00px" title=""></span></p></td>
   <td colspan="1" rowspan="1" style="border-bottom-color:rgb(0, 0, 0);border-bottom-style:solid;border-bottom-width:0pt;border-left-color:rgb(0, 0, 0);border-left-style:solid;border-left-width:0pt;border-right-color:rgb(0, 0, 0);border-right-style:solid;border-right-width:0pt;border-top-color:rgb(0, 0, 0);border-top-style:solid;border-top-width:0pt;vertical-align:top;width:298.8pt"><p><span style="-webkit-transform:rotate(0.00rad) translateZ(0px);border:0.00px solid #000000;display:inline-block;height:226.67px;margin:0.00px 0.00px;overflow:hidden;transform:rotate(0.00rad) translateZ(0px);width:397.00px"><img alt="" src="img_3538e094504b4f451c9283313b1937db5991ac5e92f421747b968a46393fea63i.jpg" style="height:248.04px;margin-left:0.00px;margin-top:-21.37px" title=""></span></p></td>
  </tr>
 </tbody>
</table>
<p><span></span></p>
<p></p>
<p><span>I’ve been thinking about that for a while. I can do better. There are a number of “object removal” techniques in NLEs these days, but none that I know to be available in “community” editions of these softwares, and I’ve not been impressed by the trial versions I’ve seen -- for example there are a number of workflows that start by “lasso/select the object to be removed in the frame”, and that’s already a no-starter as I’m not going to select that draw-bar in every single frame.</span></p>
<p></p>
<p><span>Instead it looks to me like an algorithm could “easily” find that bar in the image because it has some very distinguishable characteristics. For starters, it’s a rather uniform color which always contrasts with the rails or engine background. And then it’s mostly vertical (but not quite, especially in turns), and finally it always reaches to the bottom of the image.</span></p>
<p></p>
<p><span>I’ve looked into a number of solutions on how to detect the draw-bar. My initial choice was OpenCV but I didn’t see a detector that would work for my case; the second choice was AI since that’s the killer buzzword these days, and I don’t see how I can reliably train a model to detect that.</span></p>
<p></p>
<p><span>However, good old school image analysis seems obvious here: if I can track at least one point that is on that gray rod, then a simple line-scanning algorithm can detect the left/right borders, followed by another simple flood-fill-like algorithm to follow that vertically. A few experiments also showed that if I work in HLS, the luma channel is all I need, and I can boost the contrast to the max to make the borders even more recognizable. In essence, I have a very dedicated boundary detection algorithm.</span></p>
<p></p>
<p><span>The next step is to do the “removal” part… It’s nice to detect the draw-bar, but what should it be replaced with? Here we can take a big shortcut: the background is </span><span style="font-style:italic">mostly</span><span>&nbsp;the track, with rails on each side and </span><span style="font-style:italic">horizontal</span><span>&nbsp;ties. See where I’m going here? If we can detect the space between the rails, we merely need to get the pixels on the left and right of the draw-bar and do a simple fill with some blending, horizontally, line by line. So that’s what I tried and the results were very promising from the start. Here’s an example of the track-filling algorithm showing how good that naïve simple method can get:</span></p>
<p></p>
<p style="text-align:center"><span style="-webkit-transform:rotate(0.00rad) translateZ(0px);border:0.00px solid #000000;display:inline-block;height:441.00px;margin:0.00px 0.00px;overflow:hidden;transform:rotate(0.00rad) translateZ(0px);width:797.00px"><img alt="" src="img_437e7b0819771d777b50d6b5ad1d61c12391bfe8d0ae25013789a908d73b2c3bi.jpg" style="height:489.00px;margin-left:0.00px;margin-top:-48.00px" title=""></span><span><br></span><span style="font-style:italic">Can you spot where the draw-bar used to be?</span></p>
<p></p>
<p><span>As for the implementation and usage, I decided to go with </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.blackmagicdesign.com/products/davinciresolve" style="color:inherit;text-decoration:inherit">DaVinci Resolve</a></span><span>&nbsp;since it’s my current de-facto NLE. Turns out that DaVinci Resolve integrates </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.steakunderwater.com/" style="color:inherit;text-decoration:inherit">Eyeon’s Fusion</a></span><span>&nbsp;since version 16, and that Fusion has an excellent plugin system called </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.steakunderwater.com/VFXPedia/96.0.243.189/index2efb.html?title=Eyeon:Script/Reference/Applications/Fuse" style="color:inherit;text-decoration:inherit">Fuses</a></span><span>&nbsp;with a very easy to use </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://documents.blackmagicdesign.com/UserManuals/Fusion_Fuse_SDK.pdf?_v=1658361162000" style="color:inherit;text-decoration:inherit">Fuse SDK</a></span><span>. Fuse scripts are written in </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://lua.org/" style="color:inherit;text-decoration:inherit">Lua</a></span><span>, which one learns in seconds, and they run very fast with </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://luajit.org/" style="color:inherit;text-decoration:inherit">LuaJIT</a></span><span>.</span></p>
<p></p>
<p><span>The result is a fairly simple DaVinci “Fuse” script that I wrote and refined over two weeks:</span></p>
<p><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/alf-labs/lightworks/blob/main/fusion/fuses/RalfCamCarRodRemoval.fuse" style="color:inherit;text-decoration:inherit">https://github.com/alf-labs/lightworks/blob/main/fusion/fuses/RalfCamCarRodRemoval.fuse</a></span></p>
<p></p>
<p><span>Performance is actually better than I expected. Since I’ve never used Lua nor the Fuse SDK before, I’m sure there are things that could be improved.</span></p>
<p></p>
<p><span>To use this, I first set a “Tracker” in Fusion to track the top part of the rod draw-bar. That defines an origin point in the rod that moves with it in the video, then my algorithm detects the rod and replaces it. There are a few parameters I can tweak.</span></p>
<p></p>
<p><span>The result is pretty good, keeping in mind I started this project a couple weeks ago.</span></p>
<p></p>
<p><span>There are a few limitations:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>One is turnouts… obviously turnouts have at least one rail crossing the track so that makes a somewhat odd effect, but it’s acceptable.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The other thing that I did not think of is… tunnels. Turns out it’s really hard to detect an object when it becomes black on top of black, who knew! That just needs to be solved by carefully editing these sections out.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span style="-webkit-text-decoration-skip:none;text-decoration:line-through;text-decoration-skip-ink:none">Finally there’s the part where the rod draw-bar connects to the engine. I’ve tried removing it but that creates unsightly artifacts, so for now I’m keeping it. I’ll figure that one out in version 2.0 of the plugin</span><span>.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Another week of work, and after some more research and trial-and-error, I managed to remove the draw-bar coupler from the video using a combination of DaVinci Fusion “Clone Paint” tool and a Color Node with an image tracker.</span></li>
</ul>
<p></p>
<p><span>Here’s a new render from one of my older videos, applying the new effect plugin. </span></p>
<p></p>
<p><span>New version:</span></p>
<p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><iframe width="560" height="315" src="https://www.youtube.com/embed/LjKOmGvScYE" frameborder="0" allowfullscreen></iframe></span></p>
<p></p>
<p></p>
<p><span>Old version:</span></p>
<p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><iframe width="560" height="315" src="https://www.youtube.com/embed/cCgmxwlEHYE" frameborder="0" allowfullscreen></iframe></span></p>
<p></p>
<p></p>
<hr>
<p></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2023-07-01_conductor_2_w_google_analytics_4.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-05-21_conductor_2_now_the_default__3eef9fa3.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-01 by Rig4j 0.1-Exp-0c45755&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

