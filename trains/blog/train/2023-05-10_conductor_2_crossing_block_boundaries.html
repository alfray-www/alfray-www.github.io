<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/2023-05-10_conductor_2_crossing_block_boundaries.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Conductor 2: Crossing Block Boundaries" />

<meta property="og:description" content="Now I understand the issue that was affecting the automated freight train; it's quite interesting and worth elaborating." />


<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="Conductor 2: Crossing Block Boundaries" />

<meta name="twitter:description" content="Now I understand the issue that was affecting the automated freight train; it's quite interesting and worth elaborating." />


<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0002.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<table style="border-collapse:collapse;border-spacing:0;margin-left:auto;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/" style="color:inherit;text-decoration:inherit">Train Pages</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/train/" style="color:inherit;text-decoration:inherit">Tech Blog</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac.html" style="color:inherit;text-decoration:inherit">RTAC Software</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.youtube.com/c/raphaelmoll" style="color:inherit;text-decoration:inherit">Videos</a></span></p></td>
  </tr>
 </tbody>
</table>
<p></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2023-05-21_conductor_2_now_the_default__3eef9fa3.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-05-06_conductor_2_the_flaky_sensors_issue.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2023-05-10 - Conductor 2: Crossing Block Boundaries</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">Rtac</span>
    </span>
    </div>


    <p><span></span></p>
<p></p>
<p><span>Now I understand the issue that was affecting the automated freight train; it's quite interesting and worth elaborating.</span></p>
<p></p>
<p><span>First, as a recap, the freight route is a shuttle composed of 2 blocks. The train starts on say block A, travels to the consecutive block B, stops, and reverses to block A. The sequence is very simple:</span></p>
<p></p>
<p class="console "><span>Step / State Block A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;State Block B&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description<br>1- </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ A </span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;</span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;occupied </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;] &nbsp; [ B inactive </span><span style="background-color:rgb(255, 242, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; empty &nbsp; </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;]</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Start from A</span><span style="font-family:&quot;Consolas&quot;;font-size:9pt"><br></span><span>2- </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ A inactive </span><span style="background-color:rgb(252, 229, 205);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;trailing </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;] &nbsp; [ B </span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;</span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;occupied </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;]</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Crosses from A to B</span><span style="font-family:&quot;Consolas&quot;;font-size:9pt"><br></span><span>2- </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ A inactive </span><span style="background-color:rgb(252, 229, 205);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;trailing </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;] &nbsp; [ B </span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;</span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;occupied </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;]</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Stops &amp; Reverses</span><span style="font-family:&quot;Consolas&quot;;font-size:9pt"><br></span><span>3- </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ A </span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;</span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;occupied </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;] &nbsp; [ B inactive </span><span style="background-color:rgb(252, 229, 205);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;trailing </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;]</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Crosses from B to A</span><span style="font-family:&quot;Consolas&quot;;font-size:9pt"><br></span><span>4- </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ A </span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;</span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;occupied </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;] &nbsp; [ B inactive </span><span style="background-color:rgb(255, 242, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; empty &nbsp; </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;]</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Stops back on A and resets</span></p>
<p></p>
<p><span>Note how although we have 5 logical steps, there are only 4 different steps from the sensor/block occupancy point of view -- there is no difference whether the engine is running on block B or stopped and waiting till it reverses.</span></p>
<p><span></span></p>
<p></p>
<p><span>As the train moves forward from A towards B, at some point it crosses the boundary: block A’s sensor changes from “active” to “inactive”, and the logical occupancy status changes from “occupied” to “trailing” -- a trailing block is the last one the train occupied before the currently occupied block. Since this route has 2 blocks, they alternate between trailing &amp; occupied because as the train is running the </span><span style="font-style:italic">other</span><span>&nbsp;block is always the “last block used”.</span></p>
<p></p>
<p><span>Now we need to look more closely at the train crossing the boundary between blocks A to B. We need to remember that these types of block detectors sense current. In this case they sense the engine and that's it. The following cars are not detected.</span></p>
<p><span>First the engine bridges blocks A and B, making them briefly look both occupied -- the front and rear wheels are electrically connected so they temporarily bridge rails from both blocks A and B, thus triggering both sensors as the train crosses the boundary.</span></p>
<p><span>Once the engine is fully on block B, block A should be detected as empty -- it changes state from occupied to trailing.</span></p>
<p><span>But as each car crosses the trail junction, the metal wheels briefly touch both rails and thus also briefly connect blocks A and B, making block A "blink" on and off quickly on the sensor.</span></p>
<p><span>Now that scenario is already handled, that’s exactly why the “last occupied” block is marked as trailing: we know that the sensor can go on/off quickly on a trailing block, and we can ignore that in the Conductor logic.</span></p>
<p></p>
<p><span>Now let’s add “flaky sensors” to this mix. These sensors detect current and have a limited sensitivity range. If an engine does not use enough current, the sensor may not detect the train at all, or it could be borderline. In a borderline case, the sensor detects the running train on and off as we oscillate around the sensor’s detection threshold.</span></p>
<p><span>So again, Conductor 2 already handles that: if a block is marked trailing </span><span style="font-style:italic">or</span><span>&nbsp;occupied and its sensor “blinks”, we simply ignore it. That works great for the common case of a train traversing a series of blocks, say X → Y → Z. If we know the train occupied block Y and the sensor “blinks”, it’s fine: we can ignore it because we know the train must still be on block Y so it’s still the occupied block -- until the sensor trigger for block Z, in which case Z becomes the occupied block, and Y becomes the trailing one.</span></p>
<p></p>
<p><span>In my case, the sensor for block B has poor sensitivity and is flaky. And even though this is well handled in the case of a train going </span><span style="font-style:italic">through</span><span>, it fails very subtly for the reversing shuttle case. Let’s reexamine the steps from before, but let’s add a “flaky” sensor B that can become inactive </span><span style="font-style:italic">even when the train is running</span><span>:</span></p>
<p></p>
<p class="console "><span>Step / State Block A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;State Block B&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description<br>1- </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ A </span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;</span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;occupied </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;] &nbsp; [ B inactive </span><span style="background-color:rgb(255, 242, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; empty &nbsp; </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;]</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Start from A</span><span style="font-family:&quot;Consolas&quot;;font-size:9pt"><br></span><span>2- </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ A inactive </span><span style="background-color:rgb(252, 229, 205);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;trailing </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;] &nbsp; [ B </span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;</span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;occupied </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;]</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Crosses from A to B<br>Sensor B is flaky with this engine, and sometimes fails to detect the engine (making block B seem inactive). At the same time, the train is crossing the boundary and the wheels can short block A and B, making A seem active. This looks like this from the view of the Conductor logic:<br>?- </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ A </span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp;?? &nbsp; &nbsp; ] &nbsp; [ B inactive &nbsp; &nbsp; ?? &nbsp; &nbsp; ]</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;What is this step?<br>⇒ This doesn’t look like Step 2 anymore, it looks like step 3!</span><span style="font-family:&quot;Consolas&quot;;font-size:9pt"><br></span><span style="-webkit-text-decoration-skip:none;text-decoration:line-through;text-decoration-skip-ink:none">2- </span><span style="-webkit-text-decoration-skip:none;font-family:&quot;Consolas&quot;;font-size:9pt;text-decoration:line-through;text-decoration-skip-ink:none">[ A inactive </span><span style="-webkit-text-decoration-skip:none;background-color:rgb(252, 229, 205);font-family:&quot;Consolas&quot;;font-size:9pt;text-decoration:line-through;text-decoration-skip-ink:none">&nbsp;trailing </span><span style="-webkit-text-decoration-skip:none;font-family:&quot;Consolas&quot;;font-size:9pt;text-decoration:line-through;text-decoration-skip-ink:none">&nbsp;] &nbsp; [ B </span><span style="-webkit-text-decoration-skip:none;background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt;text-decoration:line-through;text-decoration-skip-ink:none">&nbsp;active </span><span style="-webkit-text-decoration-skip:none;font-family:&quot;Consolas&quot;;font-size:9pt;text-decoration:line-through;text-decoration-skip-ink:none">&nbsp;</span><span style="-webkit-text-decoration-skip:none;background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt;text-decoration:line-through;text-decoration-skip-ink:none">&nbsp;occupied </span><span style="-webkit-text-decoration-skip:none;font-family:&quot;Consolas&quot;;font-size:9pt;text-decoration:line-through;text-decoration-skip-ink:none">&nbsp;]</span><span style="-webkit-text-decoration-skip:none;text-decoration:line-through;text-decoration-skip-ink:none">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Stops &amp; Reverses</span><span style="font-family:&quot;Consolas&quot;;font-size:9pt"><br></span><span>3- </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ A </span><span style="background-color:rgb(244, 204, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;active </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;</span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;occupied </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;] &nbsp; [ B inactive </span><span style="background-color:rgb(252, 229, 205);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;trailing </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;]</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Crosses from B to A</span><span style="font-family:&quot;Consolas&quot;;font-size:9pt"><br></span><span>3- </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ A inactive </span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;occupied </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;] &nbsp; [ B inactive </span><span style="background-color:rgb(252, 229, 205);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;trailing </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;]</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Stops back on A</span><span style="font-family:&quot;Consolas&quot;;font-size:9pt"><br></span><span>4- </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">[ A inactive </span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;occupied </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;] &nbsp; [ B inactive </span><span style="background-color:rgb(255, 242, 204);font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; empty &nbsp; </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp;]</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Stops back on A and resets</span></p>
<p></p>
<p><span>As indicated above, once a block becomes occupied, we stop ignoring its sensor -- it’s fine if it “blinks” and oscillates between active and inactive states. Thus the two steps 3 above are perfectly “valid” and the same state from the automation’s logic point of view.</span></p>
<p></p>
<p><span>The consequence is that as soon as the sensor B flakes while the train is barely reaching block B, the automation thinks the train is… back to block A (with a flaky sensor that is permanently inactive) and has finished its shuttle route! It then triggers the corresponding timers to perform whatever operation is needed to stop the train and end the route.</span></p>
<p><span>Then when the automation tries to restart, it enters error mode because it realizes the train is detected neither on block A nor B. It’s as if it had vanished, and thus this situation cannot be recovered from.</span></p>
<p></p>
<p><span>So how can we fix this?</span></p>
<p></p>
<p><span>At first glance, an obvious issue is that the Conductor engine can instantly change from one state in the route sequence to the next one. But the physical train cannot be moving that fast. Thus a naive approach could be to add a timer: we know that a train crossing the block boundary must take at least N seconds to do so, so let’s come up with the time it takes to cross and ignore any sensor changes during that period. Unfortunately, that time is impossible to guess. It depends on the train’s length and its speed. However, we don’t have to guess -- we could allow (or force) the script writer to set that value in the script. </span></p>
<p><span>Although it’s less than perfect, this idea has some merit, so let’s add support for it:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>We’ll add support for an “enter block” time, with some kind of default (say 10 seconds).</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Let the script override that at the route level, and at the node level (per block).</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The “enter block time” is then used when a new block becomes occupied, and during that time we ignore changes to both the newly occupied and the newly trailing block sensors.</span></li>
</ul>
<p></p>
<p><span>The other issue is that the whole point of Conductor 2 is to base the shuttle route management on the automatic trigger of blocks. And as pointed above, the current block state management is “instant”: as soon as the next block in the sequence is activated, we consider it must mean the train has reached it. If we go back to the example of a linear route such as X → Y → Z, as soon as Y becomes active after X, we assume the train is on Y. And as soon as Z becomes active after Y, we assume the train is on Z, even if that happened a few milliseconds after! </span></p>
<p><span>Presented that way, one could immediately see that such a quick activation must be an error case. We currently have a timeout of the maximum time a train must spend on a block, but we don’t have a notion of a </span><span style="font-style:italic">minimum</span><span>&nbsp;time that the train must be on that block. </span></p>
<p><span>And that’s where that suggestion of an ”enter block” time start to makes sense: it can mean the minimum of time we expect to be on that block, and during that time any spurious activation of the next block must be an error for a linear route.</span></p>
<p></p>
<p><span>A sequence route currently has a “timeout” field in its script definition, and that’s the max time it can take to cross the block, so we’ll want to rename that field to avoid confusion. Instead we’ll have two fields:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>maxSecondsOnBlock: The maximum time spent moving on the block.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>minSecondsOnBlock: The minimum time once entered before we can reach the next block. It must cover </span><span style="font-style:italic">at least</span><span>&nbsp;the time needed to initially fully enter the block.</span></li>
</ul>
<p><span>That will help clarify what the “timeout” means. We’ll also want to have a value for the route, and a </span><span style="font-style:italic">possible</span><span>&nbsp;override for each node. Our A/B shuttle could be rewritten this way:</span></p>
<p></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">val Shuttle_Route = MyRoute.sequence {</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; name = "Shuttle"</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; throttle = MyThrottle</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; </span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">minSecondsOnBlock = 10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// default if not specified in a node</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; </span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">maxSecondsOnBlock = 120&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 2 minutes per block max by default</span></p>
<p style="margin-left:36pt;text-align:left"></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; val A_fwd = node(A) {</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp; &nbsp; onEnter { … }</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; }</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; val B_fwd = node(B) {</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">minSecondsOnBlock = 60 &nbsp;// custom min time for this block/node</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp; &nbsp; onEnter { … }</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; }</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; val A_rev = node(A) {</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="background-color:rgb(217, 234, 211);font-family:&quot;Consolas&quot;;font-size:9pt">minSecondsOnBlock = 30</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp; &nbsp; onEnter {</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; after (40.seconds) then {</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BL.stop()</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } and_after (100.seconds) then {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// see below</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BL.sound(false)</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; }</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">&nbsp; &nbsp; sequence = listOf(A_fwd, B_fwd, A_rev)</span></p>
<p style="margin-left:36pt;text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt">}</span></p>
<p></p>
<p><span>It may also </span><span style="font-style:italic">seem</span><span>&nbsp;helpful to assert that any “after” rule used has a time that is less than the max time allocated on a block. We’re not currently doing that, for a good reason: in the example above, we have 2 timers when reaching back to block A which time (40+100 seconds) is greater than the maxSecondsOnBlock (120 seconds in that example). But the problem is that the max time is with the train </span><span style="font-style:italic">moving</span><span>&nbsp;-- we reset the timer when the train stops. That allows a train to stop at a station and have that time not count against the max time spent on the block. Thus that example above is perfectly valid -- the train should have spent 40 seconds </span><span style="font-style:italic">moving</span><span>&nbsp;on that block before stopping, well under 2 minutes.</span></p>
<p></p>
<hr>
<p></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2023-05-21_conductor_2_now_the_default__3eef9fa3.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-05-06_conductor_2_the_flaky_sensors_issue.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-05 by Rig4j 0.1-Exp-05cc7b2&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

