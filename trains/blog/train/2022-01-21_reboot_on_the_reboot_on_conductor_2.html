<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/2022-01-21_reboot_on_the_reboot_on_conductor_2.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Reboot on the Reboot on Conductor 2" />

<meta property="og:description" content="That Conductor 2&nbsp;project has been taking too long now. I still think there are good ideas in the design and the core foundation for it. The implementation has been taking forever due to a lack of clarity combined with some other projects taking precedence." />


<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="Reboot on the Reboot on Conductor 2" />

<meta name="twitter:description" content="That Conductor 2&nbsp;project has been taking too long now. I still think there are good ideas in the design and the core foundation for it. The implementation has been taking forever due to a lack of clarity combined with some other projects taking precedence." />


<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0005.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2022-01-22_conductor_2_error_management.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2021-07-04_how_do_the_electroluminescen_1afa26de.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2022-01-21 - Reboot on the Reboot on Conductor 2</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">Rtac</span>
    </span>
    </div>


    <p><span></span></p>
<p></p>
<p><span>That </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac" style="color:inherit;text-decoration:inherit">Conductor 2</a></span><span>&nbsp;project has been taking too long now. I still think there are good ideas in the design and the core foundation for it. The implementation has been taking forever due to a lack of clarity combined with some other projects taking precedence. </span></p>
<p></p>
<p><span>In between I have started an implementation in Groovy which is not quite satisfactory. It was merely a prototype to explore the DSL syntax and as such the project structure has not been carefully planned. It’s already hard to extend and I realize I’m not able to express the script logic as I want with it. The core issue is that the prototype tried to do too many things -- explore how to create a Groovy DSL, figure out the language I need, and at the same time the business logic of the script. So I have a bit of everything, and nothing concrete for each category. </span></p>
<p></p>
<p><span>So let’s reboot it. Let’s tackle it differently. Ignore the syntax. Focus on what the script business logic needs to work. I can express that “on the paper” using the ANTLR script language from Conductor 1. I’ll figure the DSL and engine structure from there.</span></p>
<p style="text-align:left"><span></span></p>
<p></p>
<p><span>Some thoughts here:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Stop using timers as functions. Introduce a real “Function Name -&gt; { instruction }” syntax.</span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Functions are invoked by using just their name in an instruction sequence.</span></li>
 </ul>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Unify the instruction format to be:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object [ Action ] [ = Parameters ]</span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Some objects may not have an action.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Some actions may not have parameters.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Parameter types: literals int or string, object names, lists, or dictionaries.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>When parameters are lists, unify to be a comma-separated one.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>This changes:</span></li>
  <ul>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Enum lists need commas.</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>GA-Event &amp; JSON-Event need an = before their parameters.</span></li>
  </ul>
 </ul>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Uniformize “instruction sequences” to be:</span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>A ;-separated list of instructions, with no end ;</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>A { ;-separated list } block, which allows nesting.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The { } block is itself an instruction so use { … } ; to have it in a list.</span></li>
 </ul>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The { } blocks create sequences of instructions.</span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>There is no scoping in the sense of limited variable scopes. All definitions are global.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Any place that currently allows an instruction sequence can use a block: -&gt; { …} is the syntax.</span></li>
 </ul>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>We introduce a syntax for “scoped variables”, or more exactly “object properties”. See below.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>We add the definition of a Route:</span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>A route has properties: throttle, </span><span style="-webkit-text-decoration-skip:none;text-decoration:line-through;text-decoration-skip-ink:none">toggle</span><span>, </span><span style="-webkit-text-decoration-skip:none;text-decoration:line-through;text-decoration-skip-ink:none">an enum state</span><span>, error.</span></li>
  <ul>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>These are accessed from within the route as “Self.&lt;property”&gt;</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>And outside as &lt;RouteName&gt;.&lt;property&gt;</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span style="-webkit-text-decoration-skip:none;text-decoration:line-through;text-decoration-skip-ink:none">The “toggle” property is not used for now. Omit it.</span></li>
  </ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>A route has a type / driver / route manager.</span></li>
  <ul>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The only types are the fixed-block manager (default), or idle.</span></li>
  </ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The default manager has these properties:</span></li>
  <ul>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>There’s one active block, which is where the train should be / occupied.</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>It’s an error to have 0 or more than 1 block occupied.</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The route has a “block list”. </span></li>
   <ul>
    <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>This indicates which block we’re starting from.</span></li>
    <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Block occupation can only move from one block to the expected </span><span style="font-style:italic">next </span><span>one. Activating a different block results in an error.</span></li>
   </ul>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>When a new block is occupied, the “enter block” instructions are executed.</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>When the route is activated, the first block is “entered” with the engine in Stopped mode.</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>To handle shuttle modes, the “enter block” is considered to be re-entered when the direction changes.</span></li>
  </ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The “idle” manager is a special one. It defines a route that controls no trains and does nothing.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Routes are either active or inactive. There’s a corresponding function executed: OnActivate, OnDeactivate.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Routes define a number of block instructions: “[ Block | Enter ] [ Sensor ] [Forward | Reverse | Stopped] -&gt; { instructions }”</span></li>
  <ul>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The Forward/Reverse/Stopped refers to the current state of Route’s Throttle.</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The Block/Sensor number refers to the Route’s </span><span style="font-style:italic">current</span><span>&nbsp;block being occupied.</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>A “Block” definition means the instructions are evaluated </span><span style="font-style:italic">every</span><span>&nbsp;time that this block is active with the engine in that current direction.</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>An “Enter” definition means the instructions are evaluated </span><span style="font-style:italic">once</span><span>&nbsp;when that block is activated in the block sequence.</span></li>
   <ul>
    <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>However if there’s an “After” instruction, it is started and continues to be evaluated if the block is still active with the right direction.</span></li>
    <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Or said otherwise, any block change in the route cancels any pending timer.</span></li>
   </ul>
  </ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Routes have “event” functions. For now:</span></li>
  <ul>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>OnActivate</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>OnDeactivate</span></li>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>OnError</span></li>
  </ul>
 </ul>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>We add the definition of an “ActiveRoute”:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActiveRoute Route-Name = Route1 Route2 Route3…</span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>This behaves as an enum that select one and only one of multiple routes.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>There is no concept of “null” so we must define an empty “idle” route as the default. This has the side effect that the idle route can have OnActivate/OnDeactivate functions.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>By default the first route is the active one.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>An ActiveRoute object has one instruction: Activate<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route-Name = Activate Route2</span></li>
 </ul>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>We define a new instruction named “After”: </span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Simple form:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;After [Int | Timer] -&gt; { instructions }”.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Chained form:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;After [Int | Timer] -&gt; { instructions 1 }”<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Then After [Int | Timer] -&gt; { instructions 2 }”...</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>This is the same as starting a timer with the given delay.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The argument can be a literal number, or an integer variable, or a Timer variable.</span></li>
  <ul>
   <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>For the 2 formers, an anonymous timer is created. For the latter, that timer is actually used.</span></li>
  </ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The instructions are carried away when the timer expires.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>If the “After” instructions are executed as part of a Route “Enter” definition, the instructions are only executed if the block is still active and the train is in the expected direction. </span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Once the instructions finish executing, they start the following “Then After” timer if present. This means they all form a chain, executed in sequence.</span></li>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Question: Can we have an “After” instruction inside another “After” instruction? How does that behave exactly? → Upfront I’d say no we can’t. It seems pointless and illogical.</span></li>
 </ul>
</ul>
<p></p>
<p><span>Doing this allows us to encode the same script as we have now, but with a lot of simplification in the script text.</span></p>
<p></p>
<p><span>On the scripting side, the “novelty” is adding generic support for functions and blocks of instructions. This is needed to be able to write the “After” blocks inside parent blocks.</span></p>
<p></p>
<p><span>The core structural change is the handling of the route and active route. </span></p>
<p><span>On one hand, we can use this as “syntactic sugar”, and think of them as macros that internally generate flat conditions lists. </span></p>
<p><span>However it would make more sense to fully develop the concept of the route manager. In this case the route manager tracks the block changes and schedules executing of the various instruction sequences.</span></p>
<p></p>
<p><span style="font-weight:700">What won’t be back-ported from Conductor 2.02</span><span>:</span></p>
<p><span>One difference with Conductor 2.02 is the throttle management for a route. In v2.02, instructions inside a route implicitly used the throttle for that route. Here the throttle is externally defined and the instructions just act on a global throttle object. That lets the script be more flexible, e.g. the AM route can also act on the SP throttle to e.g. stop the sound.</span></p>
<p></p>
<p><span>One thing I’m not carrying over from Conductor 2.02 is the notion of virtual blocks. These seem pointless in this context. Blocks are purely mapped to a sensor each as in Conductor 1.</span></p>
<p></p>
<p></p>
<hr>
<p></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2022-01-22_conductor_2_error_management.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2021-07-04_how_do_the_electroluminescen_1afa26de.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-02 by Rig4j 0.1-Exp-05cc7b2&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

