<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/2022-01-23_conductor_2_block_graph_and__20eaa2e5.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Conductor 2: Block Graph and Travel Direction" />

<meta property="og:description" content="In Conductor 2, each route has its dedicated route type, driven by a “route manager”." />
<meta property="og:image"       content="https://www.alfray.com/trains/blog/train/img_0cab5acc044a02465a62a52ff2a65b518fdfb5899c76b8282b4b1c8f8fbf744cd.png" />

<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="Conductor 2: Block Graph and Travel Direction" />

<meta name="twitter:description" content="In Conductor 2, each route has its dedicated route type, driven by a “route manager”." />
<meta name="twitter:image"       content="https://www.alfray.com/trains/blog/train/img_0cab5acc044a02465a62a52ff2a65b518fdfb5899c76b8282b4b1c8f8fbf744cd.png" />

<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0005.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<table style="border-collapse:collapse;border-spacing:0;margin-left:auto;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/" style="color:inherit;text-decoration:inherit">Train Pages</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/train/" style="color:inherit;text-decoration:inherit">Tech Blog</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac.html" style="color:inherit;text-decoration:inherit">RTAC Software</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.youtube.com/c/raphaelmoll" style="color:inherit;text-decoration:inherit">Videos</a></span></p></td>
  </tr>
 </tbody>
</table>
<p></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2022-02-13_conductor_2_sequence_manager_01d550b5.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2022-01-22_conductor_2_startup_correcti_ce159044.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2022-01-23 - Conductor 2: Block Graph and Travel Direction</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">Rtac</span>
    </span>
    </div>


    <p><span></span></p>
<p></p>
<p><span>In </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac" style="color:inherit;text-decoration:inherit">Conductor 2</a></span><span>, each route has its dedicated route type, driven by a “route manager”.</span></p>
<p><span>For our shuttle routes, we define an almost linear block list of blocks traveled.</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Normal:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B311 → B321 → stop/reverse → B321 → B311.</span></li>
</ul>
<p></p>
<p><span>As seen above, to handle the rare case of the end-run overrun, we want to actually have a block graph.</span></p>
<p style="text-align:center"><span style="-webkit-transform:rotate(0.00rad) translateZ(0px);border:0.00px solid #000000;display:inline-block;height:186.00px;margin:0.00px 0.00px;overflow:hidden;transform:rotate(0.00rad) translateZ(0px);width:380.00px"><img alt="" src="img_0cab5acc044a02465a62a52ff2a65b518fdfb5899c76b8282b4b1c8f8fbf744cd.png" style="margin-left:0.00px;margin-top:0.00px" title=""></span></p>
<p style="text-align:left"><span></span></p>
<p></p>
<p><span>What we are not encoding here is the travel direction.</span></p>
<p><span>We are not encoding either which one is the startup point, not which one is the reverse point.</span></p>
<p><span>The argument is that we do not </span><span style="font-style:italic">have</span><span>&nbsp;to because a/ we don’t really need the information, and b/ if we really needed it, we could infer it from the graph.</span></p>
<p><span>So let’s discuss that.</span></p>
<p></p>
<p><span>Why don’t we need the information? In a normal setup scenario, the train is initially already located at the starting block, and stopped. This is the first block in the list. We don’t need extra information to denote that it is the start of the list.</span></p>
<p><span>As the train travels from one block to the next one, the manager keeps track of the “current active block”. It’s the one that was occupied. At some point the manager will notice the block being unoccupied, and should mark it as a trailing block, and move to the next one. </span></p>
<p><span>At the transition time, we can have 3 cases: 0 blocks occupied briefly, 1 block occupied (the next one), or 2 blocks occupied briefly.</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>0 blocks occupied. That can happen at some jonctions, or when a block sensor flickers. The manager should keep the current block active till transitioning to the new one for sure.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>1 block occupied and it’s not the active one. Is it the next or one of the possible next ones? If yes, change that to be the new active block. If the new occupied block is not in the next list, we have an error situation.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>2 blocks occupied briefly can also happen. This is similar to the previous “normal” case. If the new block is in the expected list, make it the current one.</span></li>
</ul>
<p><span>Every time the current block changes, the old current block is marked as a trailing block, and the previous trailing block is unmarked.</span></p>
<p><span>We also need to account for sensor flakiness. Any </span><span style="font-style:italic">unexpected</span><span>&nbsp;state change should not be accepted right away, and given a little bit of time to see if it goes away (e.g. 2 seconds). However we’ll treat any </span><span style="font-style:italic">expected</span><span>&nbsp;state change as immediate to avoid delaying execution of events in the expected cases.</span></p>
<p><span>It’s worth noting that all that discussion about current block changing did not mention the travel direction. We don’t need to care -- the block list is linear and always executed from start to end. We only care about the “next block(s)”, never the previous ones.</span></p>
<p></p>
<p><span>The only case where we have an ambiguity is with abnormal startups: automation starts with the train already on the track in an </span><span style="font-style:italic">expected</span><span>&nbsp;block, and we want to recover by bringing it back to the start point. The manager needs to know which one to make the current block since in a shuttle mode most blocks appear twice. But in fact that’s not even an issue since we know the recovery method is to bring the train to the </span><span style="font-style:italic">end</span><span>&nbsp;point. Thus the only logical choice is the last occurrence of the current occupied block in the list, since it’s the one closer to the end point.</span></p>
<p></p>
<p><span>Finally, we don’t need to know the running direction, but if we really wanted to, it could be deduced easily. Since these are shuttle routes, they start and stop at the same block, and they have one single reversing block. The reversing block is easy to find since it has the same block as both previous and next. The same applies to a reversing loop with more than one block: any time a block appears more than once in the graph flattened as a linear sequence, the second occurrence must have the reverse direction of the first occurrence of the same block.</span></p>
<p></p>
<p></p>
<hr>
<p></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2022-02-13_conductor_2_sequence_manager_01d550b5.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2022-01-22_conductor_2_startup_correcti_ce159044.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-04 by Rig4j 0.1-Exp-05cc7b2&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

