<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/2023-11-24_sdb_first_trolley_automation_ecde7037.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="SDB: First Trolley Automation Test, Continued" />

<meta property="og:description" content="The Software Defined Blocks&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad." />
<meta property="og:image"       content="https://www.alfray.com/trains/blog/train/img_5244b4ed2bc9b875000ac241baa0aaa5f3900b00fae020592646d8c0f37f8315i.jpg" />

<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="SDB: First Trolley Automation Test, Continued" />

<meta name="twitter:description" content="The Software Defined Blocks&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad." />
<meta name="twitter:image"       content="https://www.alfray.com/trains/blog/train/img_5244b4ed2bc9b875000ac241baa0aaa5f3900b00fae020592646d8c0f37f8315i.jpg" />

<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0001.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2024-10-12_conductor_2_sensor_issues_on_483b2f5d.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-11-11_dcc-ex_command_station.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2023-11-24 - SDB: First Trolley Automation Test, Continued</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">SDB</span>
    </span>
    </div>


    <p><span></span></p>
<p></p>
<p><span style="font-style:italic">The </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/model-railroad/sdb" style="color:inherit;text-decoration:inherit">Software Defined Blocks</a></span><span style="font-style:italic">&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad</span><span>.</span></p>
<p></p>
<p style="text-align:center"><span style="-webkit-transform:rotate(0.00rad) translateZ(0px);border:0.00px solid #000000;display:inline-block;height:282.67px;margin:0.00px 0.00px;overflow:hidden;transform:rotate(0.00rad) translateZ(0px);width:796.80px"><img alt="" src="img_5244b4ed2bc9b875000ac241baa0aaa5f3900b00fae020592646d8c0f37f8315i.jpg" style="margin-left:0.00px;margin-top:0.00px" title=""></span></p>
<p></p>
<p><span>The first prototype automation test has been overwhelmingly problematic:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>At first, I could not get the ToF sensor to reliably detect the engine. It would seem to work, then most of the time it would not detect a decreasing distance as the trolley was approaching till it was right next to the sensor.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>At the same time, my mere presence a couple feet on the side would influence the result. That’s not good.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The response time in JMRI seems extremely slow.</span></li>
</ul>
<p></p>
<p><span>Let’s detail that last one.</span></p>
<p><span></span></p>
<p></p>
<p><span>“On the paper”, I wanted the distance to be measured “in a straight line” such that it would trigger 3 blocks: 0-200 mm would be block A, 200-400 mm would be block B, and 400-2000 mm would be block C (about 8 and 16 inches thresholds for our friends with these units). Experimentation by looking just at the output of the sensor on the embedded display seemed to indicate that it should work fine.</span></p>
<p><span>Then I created virtual sensors in JMRI, and configured SDB to send JSON commands to JMRI.</span></p>
<p><span>That’s when things derail a bit. It sure works, but there’s a clear delay. For example the engine leaves, the distance increases, and the engine crosses the 200 mm distance mark. But by the time the corresponding block is seen changed in JMRI, the engine is already at the 400 mm distance mark…</span></p>
<p></p>
<p><span>I’ll need to look into that later. Why is it so slow? Could be SDB, could be the wifi, could be JMRI. Or even all of the above.</span></p>
<p></p>
<p><span>In between, I tried a couple variations and settled on one that mostly works: I create two virtual blocks which are </span><span style="font-style:italic">overlapping</span><span>. Block A covers 0-300 mm (~12 inches) and block B covers 200-2000 mm (anything above 8 inches). That seems to be more reliable. When the engine leaves, the block A→B transition happens sooner. When the engine comes back, the block B→A transition happens farther from the end, giving the engine more time to stop if needed.</span></p>
<p></p>
<p><span>The other experiment I made is to not place the sensor straight and aligned with the track. From my notes, I know the sensor detects within a cone-shaped scope. I can place the sensor a bit more on the side of the track, pointing away from the aisle where I may be working. This way it has less chance to detect me. It also means the object detected as a slightly more “sideways” motion than coming straight at the sensor, which I know is something that helps a lot for regular IR sensors.</span></p>
<p></p>
<p><span>So in the end, I got something that </span><span style="font-style:italic">seemed</span><span>&nbsp;to work. I left my prototype ESP32/sensor there to try it during the next day’s automation. </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/2023-11-25_trolley_automation_experiment.html" style="color:inherit;text-decoration:inherit">It failed in interesting ways</a></span><span>.</span></p>
<p></p>
<p><span>Right now, this is in the early stages of experimentation. This is my “MVP” (minimum viable product) test bed.</span></p>
<p></p>
<p><span>So far the conclusions are:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>SDB as in “ESP32 with sensors connecting via wifi to JMRI” works.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Even though the code for SDB is not feature complete yet, the code structure seems good and adequate.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The ToF sensor is disappointing and subpar for this application due to the geometry of the environment (too close to the track). </span></li>
</ul>
<p></p>
<p><span>For this specific automation project, I think I’ll go back to a regular current-sensing block sensor.<br>The next step is to support NCE BD20 sensors with SDB and then install that physically on site.</span></p>
<p></p>
<p><span>I will leave the actual ToF-sensor based automation in place though in between.</span></p>
<p></p>
<p></p>
<hr>
<p></p>
<p><span></span></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2024-10-12_conductor_2_sensor_issues_on_483b2f5d.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-11-11_dcc-ex_command_station.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-02 by Rig4j 0.1-Exp-05cc7b2&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

