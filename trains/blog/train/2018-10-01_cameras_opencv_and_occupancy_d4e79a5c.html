<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/2018-10-01_cameras_opencv_and_occupancy_d4e79a5c.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Cameras, OpenCV, and occupancy detectors" />

<meta property="og:description" content="A lot of my interests when it comes to model train layouts are all about automation. Automation can mean to make the trains move automatically but it can also mean to automate signaling -- displaying semaphores and search lights according to traffic on the layout. The common denominator for both is block occupancy detection, namely to know where trains are on the layout." />


<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="Cameras, OpenCV, and occupancy detectors" />

<meta name="twitter:description" content="A lot of my interests when it comes to model train layouts are all about automation. Automation can mean to make the trains move automatically but it can also mean to automate signaling -- displaying semaphores and search lights according to traffic on the layout. The common denominator for both is block occupancy detection, namely to know where trains are on the layout." />


<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0007.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<table style="border-collapse:collapse;border-spacing:0;margin-left:auto;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:119.5pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/index.html" style="color:inherit;text-decoration:inherit">Introduction</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:119.5pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Blog &amp; News</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:119.5pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/about.html" style="color:inherit;text-decoration:inherit">About the Model Railroad</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:119.5pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac.html" style="color:inherit;text-decoration:inherit">RTAC Software</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:119.5pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/videos.html" style="color:inherit;text-decoration:inherit">Videos</a></span></p></td>
  </tr>
 </tbody>
</table>
<p></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2018-10-12_cmrs_touch_panels_continued.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2018-09-15_nce_aiu01_and_motion_sensor.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2018-10-01 - Cameras, OpenCV, and occupancy detectors</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">Train</span>
    </span>
    </div>


    <p></p>
<p><span>A lot of my interests when it comes to model train layouts are all about automation. Automation can mean to make the trains move automatically but it can also mean to automate signaling -- displaying semaphores and search lights according to traffic on the layout. The common denominator for both is block occupancy detection, namely to know where trains are on the layout.</span></p>
<p></p>
<p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><iframe width="560" height="315" src="https://www.youtube.com/embed/ycCJjT7WUgk" frameborder="0" allowfullscreen></iframe></span></p>
<p style="text-align:center"><span>An early prototype of camera-based block detection</span></p>
<p></p>
<p><span></span></p>
<p><span>The traditional way is to do this electronically. Rails are cut to form blocks, and current sensors are embedded in the track feeders, allowing sensors to detect when track power is being consumed. There are a number of commercial products to do that already -- </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://ncedcc.zendesk.com/hc/en-us/articles/201254549-BD20-Block-Detector" style="color:inherit;text-decoration:inherit">BD20</a></span><span>&nbsp;and </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://ncedcc.zendesk.com/hc/en-us/articles/200933435-Auxilliary-Input-Unit-AIU01-" style="color:inherit;text-decoration:inherit">AIU01</a></span><span>&nbsp;on the NCE side, BD4 and BDL169 on the Digitrax side, SRC8 from Team Digital, etc. In O-Scale 3 rails Lionel layouts, they typically use reflective IR sensors mounted on the side of the track to trigger accessories.</span></p>
<p></p>
<p><span>All these require a lot of wiring, including careful track planning. Need to plan where the blocks start and end, have proper track feeders for these blocks, install sensors, wire them to their controllers, report to the main cab bus, etc.</span></p>
<p></p>
<p><span>A while ago it occurred to me that all this could be simplified by using cameras to detect the trains:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Either kinect-style that would detect 3d volume changes,</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Or ipcams-style that would look for visual changes.</span></li>
</ul>
<p></p>
<p><span>I’ve been dealing with IP security cams for the last decade or so. These cameras are now ubiquitous, cheap, powerful. Many models are wifi enabled, removing the need for wires. And motion-detection software for these cameras is equally ubiquitous. So why not use them?</span></p>
<p></p>
<p><span>My first test was the “</span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/model-railroad/layout-wifi" style="color:inherit;text-decoration:inherit">Translate</a></span><span>” project: </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/model-railroad/layout-wifi" style="color:inherit;text-decoration:inherit">https://github.com/model-railroad/layout-wifi</a></span></p>
<p><span>Now to make it clear, this was not the desired outcome, only a very preliminary experiment. This project was a quick early experiment with some clear constraints: detection was mostly done by locating white stickers on the track. Obviously everyone would comment on how obvious the stickers were, but that’s because looks were not important in the project. The layout was also fairly unappealing (just a bunch of EZ-Track laying around). A lot of people can’t see past this surface.</span></p>
<p></p>
<p><span>Still that test revealed some interesting facts I had not thought about before:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Because the track, nor the table, were fixed, they could shift slightly enough to perturb the markers locations recorded in the software if one was to bump into it. That was fixed by adding an offset in the configuration file.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Actual detection was done by forcing the cameras in IR “night” mode (not all cameras support that). This worked fairly well and helped remove illumination changes. One typical issue with all optical solutions is that they depend on brightness, but this allowed it to work reasonably whether the room was lit by sunlight, artificial light, or even in the dark.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>The layout, for as non-realistic as it was, had two important features: a bridge/elevated section and a tunnel. Obviously the camera could not see in the tunnel, however there was enough coverage to use the entrance and exit to form a block. The elevated section did severely limit places where blocks could be detected.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Cameras were merely 640x480. That proved quite enough for the precision needed and arguably made processing faster. No need for high resolution 4k cams here.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Camera placement quickly became something to account for early. Even mounted in the ceiling, the narrow field of vision meant I needed 2 cameras for a small 4x9” layout. I tried wide-angle cameras and found the barrel distortion to make the edges absolutely unusable.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Camera placement also had limitations with parallel track. For example a train on the first track could obscure enough of the second track given the angle of a specific camera. In one place I fixed by placing the white stickers not on the track but next to it, so that a train would inevitably cover them from a camera point of view.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Human interaction and placement also mattered. For example reaching in to rerail a car could easily trigger a block detection by masking some markers. Camera placement must account for where people stand so that they do not block the view of the layout.</span></li>
</ul>
<p></p>
<p><span>One thing I did in another experimental project later was to place IR leds in the roadbed, mounted vertically (like sensors for railroad crossings). These show up as bright points on the IR cameras, and it’s clear when they are obscured by a train, yet are invisible to us.</span></p>
<p></p>
<p><span>So quite a few interesting learnings here.</span></p>
<p></p>
<p><span>Eventually the second part of the project, which I should still get to someday, is to not use any markings on the track. Amusingly at that point, every software engineer I know would throw in “</span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://opencv.org/" style="color:inherit;text-decoration:inherit">OpenCV</a></span><span>” as some kind of battle cry. I mean it’s “computer vision”, right? Enough bragging rights and more hype than one can shake a stick at. Except I think it’s mostly overkill. What we need here is merely to detect contrast in selected sections on a series of images. That’s what the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/model-railroad/layout-wifi/blob/main/translate/src/translate/cam_sensor.go#L732" style="color:inherit;text-decoration:inherit">Go program in Translate</a></span><span>&nbsp;does. Arguably that can be using OpenCV instead but yeah, it’s overkill. I only wish </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/go-opencv/go-opencv" style="color:inherit;text-decoration:inherit">OpenCV had Go bindings</a></span><span>&nbsp;like </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/bytedeco/javacv" style="color:inherit;text-decoration:inherit">JavaCV</a></span><span>&nbsp;offers.</span></p>
<p></p>
<p><span>The one part where I think OpenCV could shine is in setup &amp; calibration. Ideally I’d want to give it an image taken by the overhead camera and have it automatically detect the track for the initial setup of the blocks boundaries. Then I’d expect to have a quick calibration to account for any position shift when turning on the layout, especially in setups such as mine where the camera is fixed to the ceiling and the layout table could shift slightly.</span></p>
<p></p>
<p><span>Finally I’d like to share another pure hypothetical case where I think camera detection and OpenCV or similar could shine, and that’s in equipment inventory. The </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="http://cmrstrainclub.org" style="color:inherit;text-decoration:inherit">CMRS club</a></span><span>&nbsp;where I belong is looking into RFID such as </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.traintraxx.com/traxx-id/" style="color:inherit;text-decoration:inherit">Traxx</a></span><span>&nbsp;to identify cars coming in and out of a yard, to help in their operating sessions. This seems to me like a problem that could be solved by computer vision. I’d envision a system using two HD cameras, placed at the throat entrance and exit of a yard, and with trains at adequate “realistic” speeds (a.k.a. “slow”), it should be enough to inventory the cars getting in and out of that yard. There’s enough similarity between cars to build a model to recognize their shape (box car, flat car, gondolas) with a bit of model training, and OpenCV or similar could be used to read the numbers on the cars.</span></p>
<p></p>
<p><span>That seems like a problem worth solving.</span></p>
<p></p>
<p></p>
<hr>
<p></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2018-10-12_cmrs_touch_panels_continued.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2018-09-15_nce_aiu01_and_motion_sensor.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-04 by Rig4j 0.1-Exp-05cc7b2&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

