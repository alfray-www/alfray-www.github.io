<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/2023-03-04_sdb_wifi_and_configuration.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="SDB: Wifi and Configuration" />

<meta property="og:description" content="The Software Defined Blocks&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad." />


<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="SDB: Wifi and Configuration" />

<meta name="twitter:description" content="The Software Defined Blocks&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad." />


<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="0003.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2023-03-12_conductor_2_test-only_deployment.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-02-28_sdb_using_freertos_tasks_priorities.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2023-03-04 - SDB: Wifi and Configuration</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">SDB</span>
    </span>
    </div>


    <p><span></span></p>
<p></p>
<p><span style="font-style:italic">The </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/model-railroad/sdb" style="color:inherit;text-decoration:inherit">Software Defined Blocks</a></span><span style="font-style:italic">&nbsp;project uses an ESP32 with sensors to emulate block activations for a train model railroad</span><span>.</span></p>
<p></p>
<p><span>Wifi offers the typical bootstrap dilemma on all these tiny gizmos: we need to select an SSID and enter some wifi credentials to connect to an existing network.</span></p>
<p></p>
<p><span>The typical “Arduino way” to deal with this problem is to encode both the SSID and the password in the Arduino code. That forces users to recompile the Arduino sketch before deploying.</span></p>
<p><span>On devices with an sdcard, a work-around is to have users create a small config file with the info that we can read at boot.</span></p>
<p><span>Here instead I want to have the traditional “wifi-enabled gizmo” behavior.</span></p>
<p></p>
<p><span>An ESP32 running SDB shall offer this behavior:</span></p>
<p style="text-align:left"><span></span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>When no configuration is present </span><span style="font-style:italic">or</span><span>&nbsp;a select GPIO override (button, etc) is held at boot, we start a Wifi ad-hoc network.</span></li>
 <ul>
  <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>Users then connect to that ad-hoc network. The device presents a web page, letting them enter the minimum Wifi info (SSID, password) we need to connect, then save it in NVS, and “reboot”.</span></li>
 </ul>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>If the device boots with a valid configuration, we simply try to connect to that wifi as a client.</span></li>
</ul>
<p></p>
<p><span>I’ve implemented this in the SDB prototype and it works very well. There’s only change I want to make: apparently the ESP-IDF framework lets us provide both an ad-hoc wifi server </span><span style="font-style:italic">and</span><span>&nbsp;connect to a wifi client at the same time.</span></p>
<p><span>This is useful for devices like the ESP32-CAM which do not have any single usable GPIO (*) -- we simply need to run the ad-hoc wifi server for a few minutes a boot. The alternative is to rely on the sdcard, which the ESP32-CAM has.</span></p>
<p></p>
<p><span>(* The ESP32-CAM has a bunch of GPIOs exposed on the device pins, but they are heavily multiplexed with </span><span style="font-style:italic">something else</span><span>, such as the camera or the sdcard. So if we do not use the sdcard, we suddenly have 3 or 4 usable pins.)</span></p>
<p></p>
<p><span>In SDB, the Wifi module is implemented here: </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/model-railroad/sdb/src/master/src/mod_wifi.h" style="color:inherit;text-decoration:inherit">https://github.com/model-railroad/sdb/src/master/src/mod_wifi.h</a></span></p>
<p></p>
<p><span>The implementation is fairly satisfactory and very simple. There are two kind of web pages being served:</span></p>
<ul style="margin:0">
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>AP is ad-hoc wifi server for initial configuration.</span></li>
 <li style="line-height:1.15;padding-bottom:0pt;padding-left:0pt;padding-top:0pt"><span>STA is the “regular” wifi client connecting to an existing wifi network.</span></li>
</ul>
<p><span>In both cases, we have an HTML page; a script compresses using gzip and encodes it in a C header, which is then served from the wifi module. Both web pages exchange data with the ESP32 using JSON. This allows the configuration page to fetch properties exposed by either the block modules, the sensor modules, or the server modules, as well as post back updated configuration forms. Live data from the sensors can also be queried.</span></p>
<p></p>
<hr>
<p></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2023-03-12_conductor_2_test-only_deployment.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2023-02-28_sdb_using_freertos_tasks_priorities.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-02 by Rig4j 0.1-Exp-05cc7b2&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

