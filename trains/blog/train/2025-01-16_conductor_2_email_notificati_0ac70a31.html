<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for Blog: Model Train-related Notes" />

<meta property="og:url"         content="https://www.alfray.com/trains/blog/train/2025-01-16_conductor_2_email_notificati_0ac70a31.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Conductor 2: Email Notifications when the Automation Breaks" />

<meta property="og:description" content="Back in December I was fighting with the spurious block activation of block B360. This would break the automation, and I would have no real report about it. Of course I already have a custom web dashboard that shows me the status of the automation and after-the-fact analytics&nbsp;-- what kind of automation would that be without such dashboards? Still I figured having a “realtime” notification on failure would be better than periodically checking my custom dashboard." />


<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="Conductor 2: Email Notifications when the Automation Breaks" />

<meta name="twitter:description" content="Back in December I was fighting with the spurious block activation of block B360. This would break the automation, and I would have no real report about it. Of course I already have a custom web dashboard that shows me the status of the automation and after-the-fact analytics&nbsp;-- what kind of automation would that be without such dashboards? Still I figured having a “realtime” notification on failure would be better than periodically checking my custom dashboard." />


<title>Blog: Model Train-related Notes</title>

<script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5c66171070e9220011ed1c61&product=inline-share-buttons" async="async"></script>

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: sans-serif;
    margin: 0;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #428bca;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}


.banner-bg-image {
    height: 50px;
    background-image: url("header.jpg");
    background-position: center;
    background-size: 100% auto;
}

@media screen and (min-width: 600px) {
    .banner-bg-image {
        height: 200px;
    }
}


.title-container {
    color: #fff;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
    font-family: sans-serif;
}

.title-container a {
    color: #fff;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #fff;
    background-color: #428bca;
    font-family: sans-serif;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #428bca;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #fff;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-title-link {
    color: #fff;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-family: sans-serif;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-family: sans-serif;
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="no-margin-container banner-bg-image text-hide">
        Site Banner Image
    </div>

    <div class="title-container">
        <a href="https://www.alfray.com/trains/">Ralf's Train Pages</a>
        
        /
        <a href="index.html">Blog: Model Train-related Notes</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p><span> </span></p>
<p><span></span></p>
<p><span> </span></p>
<table style="border-collapse:collapse;border-spacing:0;margin-left:auto;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/" style="color:inherit;text-decoration:inherit">Train Pages</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/train/" style="color:inherit;text-decoration:inherit">Tech Blog</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac.html" style="color:inherit;text-decoration:inherit">RTAC Software</a></span></p></td>
   <td colspan="1" rowspan="1" style="background-color:rgb(103, 78, 167);border-bottom-color:rgb(255, 255, 255);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(255, 255, 255);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(255, 255, 255);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(255, 255, 255);border-top-style:solid;border-top-width:1pt;padding:7.2pt 7.2pt 7.2pt 7.2pt;vertical-align:top;width:149.4pt"><p style="text-align:center"><span style="-webkit-text-decoration-skip:none;color:rgb(255, 217, 102);font-size:14pt;font-weight:700;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.youtube.com/c/raphaelmoll" style="color:inherit;text-decoration:inherit">Videos</a></span></p></td>
  </tr>
 </tbody>
</table>
<p></p>
<p><span style="font-style:italic">Model Train-related Notes Blog -- t</span><span style="font-style:italic">hese are personal notes and musings on the subject of model train control, automation, electronics, or whatever I find interesting. I also have more posts in a blog dedicated to the maintenance of the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);font-style:italic;text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/randall/" style="color:inherit;text-decoration:inherit">Randall Museum Model Railroad</a></span><span style="font-style:italic">.</span></p>
<p><span></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2025-03-20_indicator_for_turnout_t330.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2024-12-25_conductor_2_activated_block_handling.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2025-01-16 - Conductor 2: Email Notifications when the Automation Breaks</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">Rtac</span>
    </span>
    </div>


    <p><span></span></p>
<p></p>
<p><span>Back in December I was </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/train/2024-12-25_conductor_2_activated_block_handling.html" style="color:inherit;text-decoration:inherit">fighting with the spurious block activation of block B360</a></span><span>. This would break the automation, and I would have no real report about it. Of course I already have a custom web dashboard that shows me the status of the automation and </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/blog/train/2023-07-01_conductor_2_w_google_analytics_4.html" style="color:inherit;text-decoration:inherit">after-the-fact analytics</a></span><span>&nbsp;-- what kind of automation would that be without such dashboards? Still I figured having a “realtime” notification on failure would be better than periodically checking my custom dashboard.</span></p>
<p></p>
<p><span>I could add some email-sending capabilities to </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac.html" style="color:inherit;text-decoration:inherit">Conductor 2</a></span><span>, but that’s something I’d rather not do as it’s a bit of its own rabbit hole. The </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.debian.org/" style="color:inherit;text-decoration:inherit">Debian Linux</a></span><span>&nbsp;computer running Conductor 2 has no email capabilities, and I intend to keep it that way -- I treat it as what it is, namely an unsecured box in a public museum with fairly loose access, thus it’s basically a DMZ. </span></p>
<p></p>
<p><span>Instead what I want is for the emails to be generated by some server that I control. All I need is to get the data to that server. I could piggyback the errors on the JSON used by the RTAC status server. That would almost be </span><span style="font-style:italic">too</span><span>&nbsp;logical. Or I could publish it on the MQTT broker and then proxy it over to the email server. Well, if I’m going that route, what about </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://wiki.debian.org/Rsyslog" style="color:inherit;text-decoration:inherit">RSyslog</a></span><span>?</span></p>
<p></p>
<p><span>So that’s what I did, and I get this kind of beautiful emails:</span></p>
<p></p>
<table style="border-collapse:collapse;border-spacing:0;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="background-color:rgb(239, 239, 239);border-bottom-color:rgb(0, 0, 0);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(0, 0, 0);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(0, 0, 0);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(0, 0, 0);border-top-style:solid;border-top-width:1pt;padding:5pt 5pt 5pt 5pt;vertical-align:top;width:597.6pt"><p style="text-align:left" class="console "><span style="color:rgb(102, 102, 102);font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">From: pi@alfray.com</span></p><p style="text-align:left" class="console "><span style="color:rgb(102, 102, 102);font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">To: self@alfray.com</span></p><p style="text-align:left" class="console "><span style="color:rgb(102, 102, 102);font-family:&quot;Consolas&quot;;font-size:9pt">Subject: </span><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">New Automation Error</span></p><p style="text-align:left" class="console "><span style="color:rgb(102, 102, 102);font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">Date: Wed, 08 Jan 2025 11:00:11 -0800</span></p><p style="text-align:left" class="console "><span style="color:rgb(102, 102, 102);font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">&nbsp;</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">Jan &nbsp;8 11:00:01 consist fireman: </span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">&nbsp;CONSIST ERROR: </span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">&nbsp;10:57:38.342 R Sequence Branchline #3 Shuttle (0204) : ERROR Sequence Branchline #3 Shuttle (0204) current block &lt;BLYouBet [NS760]&gt; still occupied after 120.5 seconds. </span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">&nbsp;10:59:38.892 R Sequence Branchline #4 Recovery (0204) : ERROR Sequence Branchline #4 Recovery (0204) current block &lt;BLYouBet [NS760]&gt; still occupied after 120.0 seconds. </span></p></td>
  </tr>
 </tbody>
</table>
<p></p>
<p></p>
<p><span>Here’s how I implemented this:</span></p>
<p><span></span></p>
<p></p>
<p><span>On the automation computer, I have a cron job parsing the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.alfray.com/trains/randall/rtac.html" style="color:inherit;text-decoration:inherit">Conductor 2</a></span><span>&nbsp;logs every 5 minutes. These already have </span><span style="font-style:italic">exactly</span><span>&nbsp;the information I want to see, as shown above -- they look wonderfully cryptic to the uninitiated yet relay all the information I need. Usually I’d notice something wrong on the dashboard, and then check the logs over SSH. Thus having exactly that log delivered by email is ideal.</span></p>
<p></p>
<p><span>Obviously, the best way to collect the error log is a quick little Bash script:</span></p>
<p></p>
<table style="border-collapse:collapse;border-spacing:0;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="background-color:rgb(217, 234, 211);border-bottom-color:rgb(0, 0, 0);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(0, 0, 0);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(0, 0, 0);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(0, 0, 0);border-top-style:solid;border-top-width:1pt;padding:5pt 5pt 5pt 5pt;vertical-align:top;width:597.6pt"><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">#!/bin/bash</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">LOGGER=/usr/bin/logger</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline"># Get the last log</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">YMD=$(date +%Y-%m-%d)</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">L=$( ls -1 --sort=time conductor-log-$YMD*.txt 2&gt;/dev/null | head -n 1 )</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline"># Find all errors</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">grep -h ": ERROR " "$L" &nbsp;&gt; "current.txt"</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline"># Compare with the last "all errors"</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">LOG=$( diff --new-line-format="@ %l @" --new-file --ignore-blank-lines --text "last.txt" "current.txt" | grep @ )</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">if [[ -z "$LOG" ]]; then exit 0; fi # No new error(s) today</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">$LOGGER "@@ CONSIST ERROR: @${LOG}@"</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline"># Update "last" errors on success</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">cp "current.txt" "last.txt"</span></p></td>
  </tr>
 </tbody>
</table>
<p></p>
<p><span>This finds the most recent log file, filters using the error pattern, and compares it with the last saved error pattern file. If they differ, send the diff via the system logger. (Editor’s note: in my real bash script I use variables for </span><span style="font-style:italic">every</span><span>&nbsp;file name; I’ve just expanded and simplified them above for clarity.) Note the very specific usage of the “@” character in the diff output and the logger call -- I use that to trim the new-lines out of the log output and then will convert the “@@” pairs back to “\n” on the receiver side.</span></p>
<p></p>
<p><span>Then I just call that in a crontab every 5 minutes.</span></p>
<p></p>
<p><span>I already have the local rsyslog configured to send some of the logs I care to one of my servers -- modern </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.debian.org/releases/bookworm/" style="color:inherit;text-decoration:inherit">Debian Bookworm</a></span><span>&nbsp;doesn’t have rsyslog installed by default IIRC, so we need to install it first and configure it:</span></p>
<p></p>
<table style="border-collapse:collapse;border-spacing:0;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="background-color:rgb(255, 242, 204);border-bottom-color:rgb(0, 0, 0);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(0, 0, 0);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(0, 0, 0);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(0, 0, 0);border-top-style:solid;border-top-width:1pt;padding:5pt 5pt 5pt 5pt;vertical-align:top;width:597.6pt"><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">$ sudo apt install rsyslog</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">$ view /etc/rsyslog.conf</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">…</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">*.info;mail.none;authpriv.none &nbsp;@@dmz.alfray.com:1234</span></p></td>
  </tr>
 </tbody>
</table>
<p></p>
<p><span>On the server side, all I need is to parse the logs collected by the receiving rsyslog. Thus we need the </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://wiki.debian.org/Rsyslog" style="color:inherit;text-decoration:inherit">Debian RSyslog</a></span><span>&nbsp;package again, and this time configured to store stuff in some specific log file:</span></p>
<p></p>
<table style="border-collapse:collapse;border-spacing:0;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="background-color:rgb(252, 229, 205);border-bottom-color:rgb(0, 0, 0);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(0, 0, 0);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(0, 0, 0);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(0, 0, 0);border-top-style:solid;border-top-width:1pt;padding:5pt 5pt 5pt 5pt;vertical-align:top;width:597.6pt"><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">$ sudo apt install rsyslog</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">$ view /etc/rsyslog.conf</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">…</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">$template RemoteHost,"/tmp/logs/remote_%HOSTNAME%.log"</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">if $hostname == 'consist' then -?RemoteHost</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">&amp; stop</span></p></td>
  </tr>
 </tbody>
</table>
<p></p>
<p><span>You’ve got to admire that </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://www.rsyslog.com/doc/configuration/index.html" style="color:inherit;text-decoration:inherit">superb rsyslog syntax</a></span><span>… I’ve written my fair share of custom config files and custom associated parsers over the years, so really I don’t mind (*) -- what matters is that it’s very flexible and documentation for it is well written. (* except that I’ve come to realize over the years, like everybody else, that there’s some value in sticking everything in JSON or YAML so I don’t really code </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://github.com/ralfoide/mini-yaml-parser" style="color:inherit;text-decoration:inherit">custom parsers anymore… sort of</a></span><span>.)</span></p>
<p></p>
<p><span>Now I’m ready to have this send me an email when the last error has changed -- we can parse that server-side log and generate an email by calling </span><span style="font-style:italic">sendmail</span><span>.</span></p>
<p><span>I thought about writing a </span><span style="-webkit-text-decoration-skip:none;color:rgb(17, 85, 204);text-decoration:underline;text-decoration-skip-ink:none"><a href="https://wiki.debian.org/systemd/Services" style="color:inherit;text-decoration:inherit">systemd service daemon</a></span><span>&nbsp;at first. Should it be in Rust, NodeJS, Java, Kotlin, or Go? Let’s </span><span style="font-style:italic">not</span><span>&nbsp;even mention Perl. Nah, Bash and a simple crontab job will get us there as usual:</span></p>
<p></p>
<table style="border-collapse:collapse;border-spacing:0;margin-right:auto">
 <tbody>
  <tr style="height:0pt">
   <td colspan="1" rowspan="1" style="background-color:rgb(201, 218, 248);border-bottom-color:rgb(0, 0, 0);border-bottom-style:solid;border-bottom-width:1pt;border-left-color:rgb(0, 0, 0);border-left-style:solid;border-left-width:1pt;border-right-color:rgb(0, 0, 0);border-right-style:solid;border-right-width:1pt;border-top-color:rgb(0, 0, 0);border-top-style:solid;border-top-width:1pt;padding:5pt 5pt 5pt 5pt;vertical-align:top;width:597.6pt"><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">#!/bin/bash</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">sleep 10s</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline"># Check if log is new</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">LOG=$(grep "@@ CONSIST ERROR:" "remote_rsys.log" | tail -n 1)</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">if [[ -z "$LOG" ]]; then exit 0; fi</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">PREV=$(cat "diff.txt" 2&gt;/dev/null || echo "")</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">if [[ "$LOG" == "$PREV" ]]; then exit 0; fi &nbsp;# no new stuff</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">&nbsp;</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">echo "$LOG" &gt; "diff.txt"</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline"># re-create the newlines from @@</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">EXPANDED=$(sed 's/@@/\n/g' "diff.txt")</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">&nbsp;</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline"># Main new log</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">cat &gt; "msg.txt" &lt;&lt;EOF</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">From: $FROM_ADDRESS</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">To: $TO_ADDRESS</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">Subject: New Automation Error</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">&nbsp;</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">$EXPANDED</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">&nbsp;</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">EOF</span></p><p style="text-align:left" class="console "><span style="font-family:&quot;Consolas&quot;;font-size:9pt;vertical-align:baseline">/usr/sbin/sendmail -f "$FROM_ADDRESS" "$TO_ADDRESS" &lt; "msg.txt"</span></p></td>
  </tr>
 </tbody>
</table>
<p></p>
<p><span>I also stick that script invoked from a crontab every 5 minutes with the exception that the receiver side is offset to run 10 seconds after the sending side. That way I have at most a 5-minute delay before being notified of an automation error.</span></p>
<p></p>
<p></p>
<hr>
<p></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2025-03-20_indicator_for_turnout_t330.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2024-12-25_conductor_2_activated_block_handling.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="sharethis-inline-share-buttons"></div>

<div class="bottom-container">&nbsp;Generated on 2025-09-04 by Rig4j 0.1-Exp-05cc7b2&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-M1KDMEFC4D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M1KDMEFC4D');
</script>

</body>
</html>

