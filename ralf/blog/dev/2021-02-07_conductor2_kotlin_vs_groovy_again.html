<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"    content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author"      content="">

<link href="atom.xml" type="application/atom+xml" rel="alternate" title="Atom feed for R’alf Dev Log" />

<meta property="og:url"         content="http://www.alfray.com/ralf/blog/dev/2021-02-07_conductor2_kotlin_vs_groovy_again.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Conductor2… Kotlin vs Groovy again" />

<meta property="og:description" content="It’s been 2 years now that I started the rewrite of Conductor 2. Back then I chose Groovy, after trying Kotlin and deciding it wasn’t mature enough. In between, Kotlin usage has expanded a lot, so time to revisit." />


<meta name="twitter:card"        content="summary" />
<!-- meta name="twitter:site"    content="@flickr" / -->
<meta name="twitter:title"       content="Conductor2… Kotlin vs Groovy again" />

<meta name="twitter:description" content="It’s been 2 years now that I started the rewrite of Conductor 2. Back then I chose Groovy, after trying Kotlin and deciding it wasn’t mature enough. In between, Kotlin usage has expanded a lot, so time to revisit." />


<title>R’alf Dev Log</title>


<!-- custom fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Workbench&display=swap" rel="stylesheet">

<!-- Custom styles for this template -->
<style type="text/css">
body {
    font-family: "Workbench", monospace;
    margin: 0;
    background: #000;
    color: #0A0;

    font-optical-sizing: auto;
    font-weight: 200;
    font-style: normal;
    font-variation-settings: "BLED" 0, "SCAN" 10;
}

.main {
    margin: 8px;
}

p, span {
    line-height: 1.2;
    text-align: justify;
}

p.console {
    margin: 0;
    padding: 0;
}

.container {
    max-width: 95%;
}

@media screen and (min-width: 600px) {
    .container {
        max-width: 60rem;
    }
}

.center-horiz {
    margin: auto;
}

.no-margin-container {
}

/* Header + Title */
.blog-header {
  margin-bottom: 3rem;
  background-color: #060;
  box-shadow: inset 0 -.1rem .25rem rgba(0,0,0,.1);
}



.title-container {
    color: #FF0;
    padding: 1rem;
    line-height: 1.5;
    font-weight: 500;
    font-size: 24px;
}

.title-container a {
    color: #FF0;
    text-decoration: none;
}

.post-container {
}

.bottom-container {
    margin-top: 8px;
    color: #FF0;
    background-color: #060;
    text-align: center;
    font-size: small;
    line-height: 1rem;
}

@media screen and (min-width: 600px) {
    .bottom-container {
        font-size: x-small;
    }
}

.post-title-container {
    position: relative;
    background-color: #060;
    padding: 0.5rem;
}

.post-title {
    display: inline;
    color: #FF0;
    font-weight: 500;
    font-size: 1.5em;
}

a.post-title-link {
    color: #FF0;
    text-decoration: none;
}

.post-cat {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    padding: 0.25rem;
    background-color: #d0e0e3;
    color: #000;
    font-weight: 500;
    font-size: 1.5em;
}

a.post-cat-link {
    color: #000;
    text-decoration: none;
}

.post-cat-label {
    display: block;
    text-align: right;
    color: #000;
    font-size: 0.4em;
}

.prev-next-container {
    overflow: auto;
}

.prev-page {
    float: left;
    line-height: 2em;
}

.next-page {
    float: right;
    line-height: 2em;
}

h1, h2, h3, h4, h5, h6 {
    font-weight: bold;
}

.text-hide {
    font: 0/0 a;
    color: transparent;
    text-shadow: none;
    background-color: transparent;
    border: 0;
}

td p {
    margin: 0;
}


</style>
</head>

<body>

<header class="blog-header">

    <div class="title-container">
        <a href="http://www.alfray.com/ralf/">Ralf's Home Page</a>
        
        /
        <a href="0007.html">R’alf Dev Log</a>
        
    </div>
</header>

<main role="main">
<div class="main">
<div class="container center-horiz">

<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt"> </span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt"></span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt"> </span></p>
<p style="text-align:left"><span style="font-style:italic">The place where random ideas get written down and lost in time</span><span style="font-family:&quot;Workbench&quot;;font-size:12pt">.</span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt"></span></p>

<div class="prev-next-container">


    <span class="prev-page"><a href="2021-02-17_esp32_learning_mqtt.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2020-12-18_kotlin_and_rust.html">Older Post ⇒</a><br/></span>

</div>


    <div class="post-container">
    <div class="post-title-container"><h2 class="post-title">2021-02-07 - Conductor2… Kotlin vs Groovy again</h2>
    <span class="post-cat" title="Category">
            <span class="post-cat-label">Category</span>
            <span class="post-cat-text">DEV</span>
    </span>
    </div>


    <p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">It’s been 2 years now that I started the rewrite of Conductor 2. Back then I chose Groovy, after trying Kotlin and deciding it wasn’t mature enough. In between, Kotlin usage has expanded a lot, so time to revisit.</span></p>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">(N.D.L.R.: the goal of the Conductor 2 project is to replace the custom language from Conductor 1 by a new DSL based on top of Groovy, or Kotlin. That would allow the script to have more flexibility.)</span></p>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Overall Conductor2 with Groovy would work. Although the engine isn’t 100% operational, I rewrote most of the main automation script using Groovy and I updated it to a few new concepts that I miss in my current custom language. </span></p>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">The Conductor 2 design doc has more details on the new syntax.</span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Through the implementation, I evolved the syntax.</span></p>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">In conductor 1, we have basically a “global” namespace of “conditions --&gt; actions”.</span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">These can be expressed in the Groovy script using:</span></p>
<p style="margin-left:36pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">On { closure expression return a boolean } --&gt; { actions block }</span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">However I later rewrote the script to be more oriented for each route / block.</span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">A route is defined as a sequence of blocks that must be traversed, and there are actions for each block. This avoids the soup of global state variables that must be maintained in Conductor 1 to achieve the same thing (e.g. “passenger train on this block going forward”). The new syntax looks like this:</span></p>
<p style="margin-left:36pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Name = route {</span></p>
<p style="margin-left:36pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route = [</span></p>
<p style="margin-left:36pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BlockNumber.forward {</span></p>
<p style="margin-left:36pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onStart { actions }</span></p>
<p style="margin-left:36pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onEnter { actions } then_after delay { actions }</span></p>
<p style="margin-left:36pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;after delay { actions } then_after delay { actions }</span></p>
<p style="margin-left:36pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">} ] }</span></p>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">This scheme basically encodes most of the complexity in Conductor 1’s script, which is using timers and global state to limit actions to certain routes/blocks/directions.</span></p>
<p style="text-align:left"><span style="background-color:rgb(255, 255, 0)"></span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">There are only 3 limitations from using Groovy in the script:</span></p>
<ul style="margin:0">
 <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Symbols declared using “def” are local to the script. That goes for variables and functions.</span></li>
 <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Keywords cannot be overloaded (which is OK I guess).</span></li>
 <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span>“--&gt;” cannot be used as a method name. In Conductor 1, “--&gt;” is a </span><span style="font-style:italic">keyword</span><span style="font-family:&quot;Workbench&quot;;font-size:12pt">&nbsp;in the language. I couldn’t have that in a DSL based on Groovy.</span></li>
</ul>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">To circumvent the “--&gt;” issue, when the script is loaded I am currently doing a string replacement from “--&gt;” into “then”. The action “on { event } --&gt; { action }” thus invokes the action.then(block) method. Both are interchangeable. That’s the real definition of syntactic sugar.</span></p>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">The “def variable” is a different issue. In the original Conductor 1 script, variables are defined as such:</span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Name = Type Parameter</span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">E.g.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B320 = sensor NS784</span></p>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">While using “def B320 = Block NS784” works in Groovy too, it makes the identified B320 local to the script and not readable by my engine. Consequently I can’t e.g. debug or display the variable. Although I can register all the block variables being created in a map, I would not have the name without repeating it as an argument. F.ex.“def B320 = Block B320 NS784”.</span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">A variation would be to forgo creating variables in the script and let the engine register them in the context. E.g. the definition could simply be:</span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Block B320 NS784</span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">which would automatically create a variable named B320.</span></p>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Finally the last issue with Groovy are the exception stack traces. They are incredibly kilometer-long, verbose, yet ironically totally meaningless -- I can’t figure out where an error is in the script based on the stack trace. So what’s the point, really?</span></p>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">One word on the groovy implementation. One thing I’m proud of is that all the engine is in “plain old boring Java” and not Groovy. All Groovy DSL examples use a Groovy source, but it turns out not to be a requirement. For each class exposed in the script, there are 2 Java classes:</span></p>
<ul style="margin:0">
 <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">The script’s top class a CScript.</span></li>
 <ul>
  <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">The engine has a dagger autofactory “Script” matching that one CScript instance.</span></li>
  <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">It provides for example a method block(name), which returns a “CBlock” type.</span></li>
 </ul>
 <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">A script block is a “CBlock” class in the script, and a “Block” class in the engine.</span></li>
 <ul>
  <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">The script CBlock only provides the API needed for the script and links to the engine underlying implementation Block instance to actually set and get state.</span></li>
 </ul>
</ul>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Thus the question is can all this be done using Kotlin. </span></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Questions:</span></p>
<ul style="margin:0">
 <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Do I want a “kotlin class” or a “kotlin script” or “kotlin as a DSL”.</span></li>
 <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Am I forced to implement the DSL in kotlin?</span></li>
 <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Can “--&gt;” be a method name?</span></li>
</ul>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Note that if I’m rewriting Conductor from scratch (essentially what Conductor 2 does), it’s not out of the question to rewrite it fully in Kotlin as an exercise -- after all I’ve been wanting to do a Kotlin project for a while. It’s a bit orthogonal though, which is why the question is whether I am *forced* to implement the DSL in Kotlin. In the Groovy case, all the DSL examples are in Groovy yet it turned out to be trivial to use regular Java for the implementation.</span></p>
<p style="height:12pt;text-align:left"></p>
<p style="text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Update: Bottom line is that Conductor 2 will remain using Groovy due to:</span></p>
<ul style="margin:0">
 <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">Kotlin DSL syntax does require parentheses and string quotation marks. Only Groovy has a special sugar syntax to avoid them (known as Groovy’s “command chain”)..</span></li>
 <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">There is no way to find the variables declared in a kotlin DSL script (not without some ugly reflection at least), which is something I want to rely on here.</span></li>
 <li style="padding-bottom:0pt;padding-left:0pt;padding-top:0pt;text-align:left"><span style="font-family:&quot;Workbench&quot;;font-size:12pt">I believe I would be forced to implement the DSL in kotlin; which I did not see as a problem per se. The implementation was indeed syntactically more compact in Kotlin than Groovy, yet the structure was the same and would result in the same code basically.</span></li>
</ul>
<p style="height:12pt;text-align:left"></p>
<p style="height:12pt;text-align:left"></p>
<hr>
<p style="height:12pt;text-align:left"></p>


    </div>



<div class="prev-next-container">


    <span class="prev-page"><a href="2021-02-17_esp32_learning_mqtt.html">⇐ Newer Post</a><br/></span>
    <span class="next-page"><a href="2020-12-18_kotlin_and_rust.html">Older Post ⇒</a><br/></span>

</div>

</div> <!-- container -->
</div> <!-- main -->

<div class="bottom-container">&nbsp;Generated on 2025-09-02 by Rig4j 0.1-Exp-05cc7b2&nbsp;</div>

</main>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-GCEQ33G1MB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GCEQ33G1MB');
</script>

</body>
</html>

